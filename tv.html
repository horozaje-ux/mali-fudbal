<!doctype html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TV ‚Äì Mali fudbal</title>
  <meta name="theme-color" content="#0b1020" />
  <link rel="manifest" href="./manifest.json" />
  <style>
    :root{
      --bg:#070a14; --card:rgba(255,255,255,.06); --line:rgba(255,255,255,.10);
      --text:#e9eefc; --muted:rgba(233,238,252,.72);
      --ok:#27e38a; --warn:#ffcc66; --bad:#ff4d6d;
      --radius:22px; --glow:0 16px 40px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 450px at 15% 15%, rgba(70,120,255,.28), transparent 60%),
        radial-gradient(800px 400px at 85% 10%, rgba(255,90,180,.22), transparent 55%),
        radial-gradient(900px 500px at 50% 90%, rgba(40,255,160,.12), transparent 55%),
        linear-gradient(180deg, #050817, #070a14 55%, #050714);
      min-height:100vh;
    }
    .wrap{max-width:1400px;margin:0 auto;padding:18px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:52px;height:52px;border-radius:18px;background:linear-gradient(135deg, rgba(70,120,255,.9), rgba(255,90,180,.85));
      box-shadow:var(--glow);display:grid;place-items:center;font-weight:900;font-size:18px}
    .title{line-height:1.05}
    .title b{font-size:20px}
    .title div{font-size:12px;color:var(--muted);margin-top:4px}
    .pill{display:inline-flex;align-items:center;gap:10px;padding:10px 12px;border-radius:999px;background:rgba(255,255,255,.08);
      border:1px solid var(--line);font-size:13px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--warn);box-shadow:0 0 0 5px rgba(255,204,102,.14)}
    .dot.ok{background:var(--ok);box-shadow:0 0 0 5px rgba(39,227,138,.14)}
    .dot.bad{background:var(--bad);box-shadow:0 0 0 5px rgba(255,77,109,.14)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button, a{
      appearance:none;border:1px solid var(--line);background:rgba(255,255,255,.07);color:var(--text);text-decoration:none;
      padding:10px 12px;border-radius:14px;display:inline-flex;align-items:center;gap:8px;cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.25);transition:.15s transform,.15s background,.15s border;font-size:13px
    }
    button:hover,a:hover{transform:translateY(-1px);background:rgba(255,255,255,.11);border-color:rgba(255,255,255,.18)}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:14px}
    @media(max-width:1050px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--glow)}
    .h{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px}
    .h b{font-size:16px}
    .big{font-size:28px;font-weight:900}
    .muted{color:var(--muted)}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);font-size:12px;white-space:nowrap}
    .tag.live{border-color:rgba(255,204,102,.35);background:rgba(255,204,102,.12)}
    .tag.done{border-color:rgba(39,227,138,.35);background:rgba(39,227,138,.12)}
    .tag.wait{border-color:rgba(233,238,252,.20);background:rgba(233,238,252,.07)}
    .tableWrap{overflow:auto;border-radius:18px;border:1px solid rgba(255,255,255,.10)}
    table{width:100%;border-collapse:collapse;min-width:880px}
    th,td{padding:14px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:14px}
    th{color:rgba(233,238,252,.75);font-weight:800}
    .score{font-weight:1000}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.row2{grid-template-columns:1fr}}
    .matchBox{padding:14px;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.06)}
    .teams{display:flex;justify-content:space-between;gap:12px;margin:10px 0}
    .teams b{font-size:20px}
    .teams .scoreBig{font-size:34px;font-weight:1000}
    .foot{margin-top:12px;text-align:center;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">MF</div>
        <div class="title">
          <b>TV ‚Äì Mali fudbal</b>
          <div>Auto rotacija terena ‚Ä¢ Live + naredne utakmice</div>
        </div>
      </div>

      <div class="btns">
        <span class="pill"><span class="dot" id="dot"></span><span id="conn">Spajam se‚Ä¶</span></span>
        <span class="pill">üìç Teren: <b id="terenNow">‚Äî</b></span>
        <button id="btnFS">‚õ∂ Fullscreen</button>
        <button id="btnRotate">üîÅ Rotacija: <b id="rotState">ON</b></button>
        <button id="btnNext">‚û°Ô∏è Sledeƒái teren</button>
        <a href="./index.html">üè† Nazad</a>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="h">
          <b>LIVE na terenu</b>
          <span class="muted" id="last">‚Äî</span>
        </div>

        <div id="liveWrap" class="row2">
          <div class="matchBox muted">Uƒçitavam‚Ä¶</div>
          <div class="matchBox muted">Uƒçitavam‚Ä¶</div>
        </div>

        <div style="margin-top:14px" class="h">
          <b>Naredne utakmice (ovaj teren)</b>
          <span class="muted">sortirano po vremenu</span>
        </div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Vrijeme</th><th>Faza</th><th>Godi≈°te</th><th>Grupa</th><th>Meƒç</th><th>Status</th>
              </tr>
            </thead>
            <tbody id="tbNext">
              <tr><td colspan="6" class="muted">Uƒçitavam‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="h">
          <b>Pregled ‚Äì uskoro / u≈æivo (svi tereni)</b>
          <span class="muted">top 12</span>
        </div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Vrijeme</th><th>Teren</th><th>Faza</th><th>Meƒç</th><th>Rezultat</th><th>Status</th>
              </tr>
            </thead>
            <tbody id="tbAll">
              <tr><td colspan="6" class="muted">Uƒçitavam‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>

        <div class="foot">Savjet: ostavi otvoreno na TV-u ‚Ä¢ automatski se osvje≈æava (realtime)</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ‚úÖ tvoji podaci (publishable je OK za front)
    const SUPABASE_URL = "https://ayakstyzqrsjvrbfwgfs.supabase.co";
    const SUPABASE_KEY = "sb_publishable_DZJST_2cQWJU89oXbyMipg_0O-dmc-l";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const el = (id)=>document.getElementById(id);

    let ALL = [];
    let TERENI = ["Teren 1","Teren 2","Teren 3","Teren 4"];
    let terenIndex = 0;
    let rotateOn = true;
    let rotateTimer = null;

    function setConn(state){
      const dot = el("dot");
      const text = el("conn");
      if(state==="ok"){ dot.className="dot ok"; text.textContent="Online"; }
      else if(state==="bad"){ dot.className="dot bad"; text.textContent="Gre≈°ka"; }
      else { dot.className="dot"; text.textContent="Spajam se‚Ä¶"; }
    }

    function tagStatus(s){
      if(s==="uzivo") return `<span class="tag live">üü° u≈æivo</span>`;
      if(s==="gotovo") return `<span class="tag done">üü¢ gotovo</span>`;
      return `<span class="tag wait">‚ö™ ƒçeka</span>`;
    }

    function fmtTime(v){
      if(!v) return "‚Äî";
      const d = new Date(v);
      if(isNaN(d)) return String(v);
      return d.toLocaleString();
    }

    function scoreText(r){
      const a = (r.gol_domacin ?? 0);
      const b = (r.gol_gost ?? 0);
      return `${a} : ${b}`;
    }

    function sortByTime(a,b){
      return new Date(a.vreme || 0) - new Date(b.vreme || 0);
    }

    async function load(){
      setConn("loading");
      const { data, error } = await sb
        .from("matches")
        .select("*")
        .order("vreme", { ascending:true })
        .order("created_at", { ascending:true });

      if(error){
        setConn("bad");
        el("liveWrap").innerHTML = `<div class="matchBox" style="color:#ff4d6d;font-weight:900">Gre≈°ka SELECT: ${error.message}</div>`;
        el("tbNext").innerHTML = `<tr><td colspan="6" class="muted">‚Äî</td></tr>`;
        el("tbAll").innerHTML = `<tr><td colspan="6" class="muted">‚Äî</td></tr>`;
        return;
      }

      setConn("ok");
      ALL = data || [];
      el("last").textContent = "A≈æurirano: " + new Date().toLocaleString();

      // ako si upisao terene drugaƒçije, automatski pokupi iz baze
      const fromDb = Array.from(new Set(ALL.map(x=>x.teren).filter(Boolean)));
      if(fromDb.length) TERENI = fromDb.sort();

      render();
    }

    function render(){
      const teren = TERENI[terenIndex] || "Teren 1";
      el("terenNow").textContent = teren;

      const now = Date.now();

      // LIVE utakmice na terenu
      const live = ALL
        .filter(x => (x.teren||"") === teren)
        .filter(x => (x.status||"") === "uzivo");

      // ako nema uzivo, prika≈æi prve 2 ‚Äúƒçekaju‚Äù (najbli≈æe)
      let primary = live;
      if(!primary.length){
        primary = ALL
          .filter(x => (x.teren||"") === teren)
          .filter(x => (x.status||"") !== "gotovo")
          .slice()
          .sort(sortByTime)
          .slice(0,2);
      }else{
        primary = primary.slice(0,2);
      }

      const liveWrap = el("liveWrap");
      if(!primary.length){
        liveWrap.innerHTML = `<div class="matchBox muted">Nema utakmica na ${teren}.</div><div class="matchBox muted">‚Äî</div>`;
      }else{
        const cards = primary.map(r => `
          <div class="matchBox">
            <div class="muted">${fmtTime(r.vreme)} ‚Ä¢ ${r.faza ?? ""} ‚Ä¢ godi≈°te ${r.godiste ?? ""} ${r.grupa ? ("‚Ä¢ grupa " + r.grupa) : ""}</div>
            <div class="teams">
              <b>${r.domacin ?? ""}</b>
              <span class="scoreBig">${scoreText(r)}</span>
              <b>${r.gost ?? ""}</b>
            </div>
            <div>${tagStatus(r.status)}</div>
          </div>
        `);
        if(cards.length===1) cards.push(`<div class="matchBox muted">‚Äî</div>`);
        liveWrap.innerHTML = cards.join("");
      }

      // Naredne (ovaj teren)
      const upcoming = ALL
        .filter(x => (x.teren||"") === teren)
        .filter(x => (x.status||"") !== "gotovo")
        .slice()
        .sort(sortByTime)
        .slice(0, 8);

      const tbNext = el("tbNext");
      tbNext.innerHTML = upcoming.length ? upcoming.map(r => `
        <tr>
          <td>${fmtTime(r.vreme)}</td>
          <td>${r.faza ?? ""}</td>
          <td>${r.godiste ?? ""}</td>
          <td>${r.grupa ?? ""}</td>
          <td><b>${r.domacin ?? ""}</b> <span class="muted">vs</span> <b>${r.gost ?? ""}</b></td>
          <td>${tagStatus(r.status)}</td>
        </tr>
      `).join("") : `<tr><td colspan="6" class="muted">Nema narednih utakmica za ovaj teren.</td></tr>`;

      // Pregled svi tereni: prvo u≈æivo, pa naredne
      const allSoon = ALL
        .slice()
        .sort((a,b)=>{
          const pa = (a.status==="uzivo") ? 0 : (a.status==="ceka" ? 1 : 2);
          const pb = (b.status==="uzivo") ? 0 : (b.status==="ceka" ? 1 : 2);
          return (pa-pb) || sortByTime(a,b);
        })
        .slice(0,12);

      el("tbAll").innerHTML = allSoon.length ? allSoon.map(r => `
        <tr>
          <td>${fmtTime(r.vreme)}</td>
          <td>${r.teren ?? "‚Äî"}</td>
          <td>${r.faza ?? ""}</td>
          <td><b>${r.domacin ?? ""}</b> <span class="muted">vs</span> <b>${r.gost ?? ""}</b></td>
          <td class="score">${scoreText(r)}</td>
          <td>${tagStatus(r.status)}</td>
        </tr>
      `).join("") : `<tr><td colspan="6" class="muted">Nema utakmica.</td></tr>`;
    }

    function startRotate(){
      stopRotate();
      rotateTimer = setInterval(()=>{
        if(!rotateOn) return;
        terenIndex = (terenIndex + 1) % TERENI.length;
        render();
      }, 10000); // 10 sekundi po terenu
    }
    function stopRotate(){
      if(rotateTimer) clearInterval(rotateTimer);
      rotateTimer = null;
    }

    // Buttons
    el("btnFS").addEventListener("click", async ()=>{
      try{
        if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
        else await document.exitFullscreen();
      }catch(e){}
    });
    el("btnRotate").addEventListener("click", ()=>{
      rotateOn = !rotateOn;
      el("rotState").textContent = rotateOn ? "ON" : "OFF";
      if(rotateOn) startRotate();
    });
    el("btnNext").addEventListener("click", ()=>{
      rotateOn = false;
      el("rotState").textContent = "OFF";
      terenIndex = (terenIndex + 1) % TERENI.length;
      render();
    });

    // realtime
    sb.channel("matches-realtime-tv")
      .on("postgres_changes", { event:"*", schema:"public", table:"matches" }, () => load())
      .subscribe();

    // init
    load();
    startRotate();

    // PWA SW register
    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    }
  </script>
</body>
</html>
