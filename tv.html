<!doctype html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TV ‚Äì Mali fudbal</title>
  <meta name="theme-color" content="#0b1020" />
  <style>
    :root{
      --bg:#070a14; --card:rgba(255,255,255,.06); --card2:rgba(255,255,255,.10);
      --text:#e9eefc; --muted:rgba(233,238,252,.70); --line:rgba(255,255,255,.10);
      --ok:#27e38a; --warn:#ffcc66; --bad:#ff4d6d; --glow: 0 10px 30px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 450px at 15% 15%, rgba(70,120,255,.28), transparent 60%),
        radial-gradient(800px 400px at 85% 10%, rgba(255,90,180,.22), transparent 55%),
        radial-gradient(900px 500px at 50% 90%, rgba(40,255,160,.12), transparent 55%),
        linear-gradient(180deg, #050817, #070a14 55%, #050714);
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0 14px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg, rgba(70,120,255,.9), rgba(255,90,180,.85));box-shadow:var(--glow);display:grid;place-items:center;font-weight:900}
    .brand h1{margin:0;font-size:18px;line-height:1.1}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn);box-shadow:0 0 0 4px rgba(255,204,102,.15)}
    .dot.ok{background:var(--ok);box-shadow:0 0 0 4px rgba(39,227,138,.14)}
    .dot.bad{background:var(--bad);box-shadow:0 0 0 4px rgba(255,77,109,.14)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    a.btn, button.btn{
      appearance:none;border:1px solid var(--line);background:var(--card);color:var(--text);text-decoration:none;
      padding:10px 12px;border-radius:14px;display:inline-flex;align-items:center;gap:8px;cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,.25);transition:.15s transform,.15s background,.15s border;font-size:13px
    }
    a.btn:hover, button.btn:hover{transform:translateY(-1px);background:var(--card2);border-color:rgba(255,255,255,.18)}
    .btn.primary{background:linear-gradient(135deg, rgba(70,120,255,.75), rgba(255,90,180,.55));border-color:rgba(255,255,255,.15)}
    .grid{display:grid;grid-template-columns:1fr .45fr;gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--glow)}
    .bigTitle{font-size:20px;font-weight:900;margin:0}
    .small{font-size:12px;color:var(--muted)}
    .tableWrap{overflow:auto;border-radius:16px;border:1px solid rgba(255,255,255,.10)}
    table{width:100%;border-collapse:collapse;min-width:780px}
    th,td{padding:14px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:14px}
    th{color:rgba(233,238,252,.75);font-weight:800}
    .score{font-weight:900;font-size:16px}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);font-size:12px;white-space:nowrap}
    .tag.live{border-color:rgba(255,204,102,.35);background:rgba(255,204,102,.12)}
    .tag.done{border-color:rgba(39,227,138,.35);background:rgba(39,227,138,.12)}
    .tag.wait{border-color:rgba(233,238,252,.20);background:rgba(233,238,252,.07)}
    .panelRow{display:flex;justify-content:space-between;gap:10px;margin:10px 0;flex-wrap:wrap}
    .kpi{padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06)}
    .kpi b{display:block;font-size:16px}
    .kpi span{font-size:12px;color:var(--muted)}
    .terList{display:grid;gap:10px;margin-top:12px}
    .terBtn{padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);cursor:pointer;text-align:left}
    .terBtn.active{background:linear-gradient(135deg, rgba(40,255,160,.14), rgba(70,120,255,.18));border-color:rgba(255,255,255,.18)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">TV</div>
        <div>
          <h1 class="bigTitle" id="title">TV ‚Äì Teren</h1>
          <div class="sub" id="sub">Live prikaz rasporeda i rezultata</div>
        </div>
      </div>

      <div class="btns">
        <span class="pill"><span class="dot" id="connDot"></span><span id="connText">Spajam se‚Ä¶</span></span>
        <a class="btn" href="./index.html">üè† Poƒçetna</a>
        <a class="btn primary" href="./admin.html">‚öôÔ∏è Admin</a>
        <button class="btn" id="btnRefresh">üîÑ Osvje≈æi</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="panelRow">
          <div>
            <div class="small">Prikaz:</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <b id="terenLabel" style="font-size:20px">üèüÔ∏è ‚Äî</b>
              <span class="tag" id="modeTag">‚Äî</span>
              <span class="tag" id="godTag" style="display:none">‚Äî</span>
            </div>
            <div class="small" id="lastUpdate" style="margin-top:6px">‚Äî</div>
          </div>

          <div class="kpi">
            <b id="kpiCount">0</b>
            <span>Utakmice na terenu</span>
          </div>
        </div>

        <div class="tableWrap" style="margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>Vrijeme</th><th>Faza</th><th>Godi≈°te</th><th>Grupa</th><th>Meƒç</th><th>Rezultat</th><th>Status</th>
              </tr>
            </thead>
            <tbody id="tbody"><tr><td colspan="7" class="small">Uƒçitavam‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <b>Kontrola terena</b>
        <div class="small" style="margin-top:6px">
          Ako je rotate ON ‚Äî automatski mijenja teren.
        </div>

        <div class="terList" id="terenList"></div>

        <div style="margin-top:14px" class="small">
          Link primjer:
          <div style="margin-top:6px;word-break:break-all">
            tv.html?teren=Teren%201&rotate=off<br/>
            tv.html?rotate=on&interval=10<br/>
            tv.html?godiste=2016&rotate=on
          </div>
        </div>
      </div>
    </div>

    <div class="small" style="text-align:center;margin:14px 0;color:rgba(233,238,252,.55)">
      ¬© Mali fudbal ‚Ä¢ TV ekran
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ‚úÖ tvoji podaci
    const SUPABASE_URL = "https://ayakstyzqrsjvrbfwgfs.supabase.co";
    const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_DZJST_2cQWJU89oXbyMipg_0O-dmc-l";

    const DEFAULT_TERENI = ["Teren 1","Teren 2","Teren 3","Teren 4"];
    const DEFAULT_INTERVAL = 15; // sekunde

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);
    const el = (id)=>document.getElementById(id);

    let ALL = [];
    let TERENI = [...DEFAULT_TERENI];
    let currentTeren = DEFAULT_TERENI[0];
    let rotateOn = true;
    let intervalSec = DEFAULT_INTERVAL;
    let godisteFilter = ""; // opciono
    let timer = null;

    function getParams(){ return new URLSearchParams(location.search); }

    function setConn(state){
      const dot = el("connDot");
      const text = el("connText");
      if(state==="ok"){ dot.className="dot ok"; text.textContent="Online"; }
      else if(state==="bad"){ dot.className="dot bad"; text.textContent="Gre≈°ka"; }
      else { dot.className="dot"; text.textContent="Spajam se‚Ä¶"; }
    }

    function tagStatus(s){
      if(s==="uzivo") return `<span class="tag live">üü° u≈æivo</span>`;
      if(s==="gotovo") return `<span class="tag done">üü¢ gotovo</span>`;
      return `<span class="tag wait">‚ö™ ƒçeka</span>`;
    }

    function fmtTime(v){
      if(!v) return "‚Äî";
      const d = new Date(v);
      if(isNaN(d)) return String(v);
      return d.toLocaleString("sr-ME",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    }

    function renderTerenList(){
      const wrap = el("terenList");
      wrap.innerHTML = TERENI.map(t => `
        <button class="terBtn ${t===currentTeren ? "active" : ""}" data-t="${t}">
          üèüÔ∏è <b>${t}</b><br/>
          <span class="small">${rotateOn ? "rotate ON (manual override)" : "rotate OFF (fiksno)"}</span>
        </button>
      `).join("");

      wrap.querySelectorAll(".terBtn").forEach(b=>{
        b.addEventListener("click", ()=>{
          currentTeren = b.getAttribute("data-t");
          rotateOn = false; // klik = fiksiraj
          stopRotate();
          updateHeader();
          renderTerenList();
          render();
        });
      });
    }

    function updateHeader(){
      el("terenLabel").textContent = `üèüÔ∏è ${currentTeren}`;
      el("title").textContent = `TV ‚Äì ${currentTeren}`;

      el("modeTag").textContent = rotateOn ? `üîÅ ROTATE ON ‚Ä¢ ${intervalSec}s` : `üéØ FIX ‚Ä¢ rotate OFF`;
      el("modeTag").className = "tag " + (rotateOn ? "live" : "wait");

      if(godisteFilter){
        el("godTag").style.display = "inline-flex";
        el("godTag").textContent = `Godi≈°te ${godisteFilter}`;
        el("godTag").className = "tag done";
      }else{
        el("godTag").style.display = "none";
      }

      el("sub").textContent = godisteFilter
        ? `Prikaz za godi≈°te ${godisteFilter} ‚Ä¢ teren: ${currentTeren}`
        : `Prikaz za sve generacije ‚Ä¢ teren: ${currentTeren}`;
    }

    function startRotate(){
      if(!rotateOn) return;
      stopRotate();
      timer = setInterval(()=>{
        const idx = TERENI.indexOf(currentTeren);
        const next = TERENI[(idx + 1) % TERENI.length];
        currentTeren = next;
        updateHeader();
        renderTerenList();
        render();
      }, intervalSec * 1000);
    }

    function stopRotate(){
      if(timer){ clearInterval(timer); timer = null; }
    }

    async function load(){
      setConn("loading");
      const { data, error } = await sb
        .from("matches")
        .select("*")
        .order("vreme", { ascending:true })
        .order("created_at", { ascending:true });

      if(error){
        setConn("bad");
        el("tbody").innerHTML = `<tr><td colspan="7" style="color:#ff4d6d;font-weight:800">Gre≈°ka SELECT: ${error.message}</td></tr>`;
        return;
      }
      setConn("ok");
      ALL = data || [];

      // Ako user nema "Teren 1..4" nego druga imena, uzmi iz baze:
      const terr = Array.from(new Set(ALL.map(x=>x.teren).filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b)));
      if(terr.length){
        TERENI = terr;
        if(!TERENI.includes(currentTeren)) currentTeren = TERENI[0];
      }

      el("lastUpdate").textContent = "A≈æurirano: " + new Date().toLocaleString("sr-ME");
      updateHeader();
      renderTerenList();
      render();
      startRotate();
    }

    function render(){
      let list = ALL.filter(x => String(x.teren||"") === String(currentTeren));
      if(godisteFilter) list = list.filter(x => String(x.godiste||"") === String(godisteFilter));
      list.sort((a,b)=> new Date(a.vreme||0) - new Date(b.vreme||0));

      el("kpiCount").textContent = String(list.length);

      const tb = el("tbody");
      if(!list.length){
        tb.innerHTML = `<tr><td colspan="7" class="small" style="color:rgba(233,238,252,.7)">Nema utakmica za ovaj teren.</td></tr>`;
        return;
      }

      tb.innerHTML = list.map(r=>`
        <tr>
          <td>${fmtTime(r.vreme)}</td>
          <td>${r.faza ?? ""}</td>
          <td><b>${r.godiste ?? ""}</b></td>
          <td>${r.grupa ?? ""}</td>
          <td><b>${r.domacin ?? ""}</b> <span style="color:rgba(233,238,252,.6)">vs</span> <b>${r.gost ?? ""}</b></td>
          <td class="score">${(r.gol_domacin ?? 0)} : ${(r.gol_gost ?? 0)}</td>
          <td>${tagStatus(r.status)}</td>
        </tr>
      `).join("");
    }

    function initFromURL(){
      const p = getParams();

      const teren = p.get("teren");
      if(teren) currentTeren = teren;

      const rotate = (p.get("rotate") || "on").toLowerCase();
      rotateOn = rotate !== "off";

      const i = parseInt(p.get("interval") || "", 10);
      if(Number.isFinite(i) && i >= 5 && i <= 120) intervalSec = i;

      const god = p.get("godiste");
      if(god) godisteFilter = String(god);

      updateHeader();
    }

    // realtime
    sb.channel("matches-realtime-tv")
      .on("postgres_changes", { event:"*", schema:"public", table:"matches" }, () => load())
      .subscribe();

    el("btnRefresh").addEventListener("click", load);

    initFromURL();
    load();
  </script>
</body>
</html>
