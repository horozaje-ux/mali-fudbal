<!doctype html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TV ‚Äì Mali fudbal</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0b1020" />
  <style>
    :root{
      --bg:#070a14; --card:rgba(255,255,255,.06); --card2:rgba(255,255,255,.10);
      --text:#e9eefc; --muted:rgba(233,238,252,.70); --line:rgba(255,255,255,.10);
      --ok:#27e38a; --warn:#ffcc66; --bad:#ff4d6d; --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 450px at 15% 15%, rgba(70,120,255,.28), transparent 60%),
        radial-gradient(800px 400px at 85% 10%, rgba(255,90,180,.22), transparent 55%),
        linear-gradient(180deg, #050817, #070a14 55%, #050714);
      min-height:100vh;
    }
    .wrap{max-width:1400px;margin:0 auto;padding:18px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .title{display:flex;align-items:center;gap:12px}
    .logo{width:54px;height:54px;border-radius:16px;background:linear-gradient(135deg,#4f7cff,#ff5ab4);display:grid;place-items:center;font-weight:900}
    h1{margin:0;font-size:22px}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    @media(max-width:1050px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:16px}
    .big{font-size:18px;font-weight:900}
    .small{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.08);font-size:15px}
    th{color:rgba(233,238,252,.75);font-weight:800}
    .score{font-weight:900;font-size:18px}
    .rowHead{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    a.btn,button.btn{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;text-decoration:none;
      padding:10px 12px;border-radius:14px;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,#4f7cff,#ff5ab4)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="title">
      <div class="logo">TV</div>
      <div>
        <h1 id="terenTitle">Teren ‚Äî</h1>
        <div class="sub" id="terenSub">U≈æivo + sledeƒáe utakmice</div>
      </div>
    </div>
    <div class="btns">
      <span class="pill"><span class="dot" id="connDot"></span><span id="connText">Spajam se‚Ä¶</span></span>
      <a class="btn" href="./index.html">üè† Poƒçetna</a>
      <a class="btn primary" href="./admin.html">‚öôÔ∏è Admin</a>
      <button class="btn" id="btnRefresh">üîÑ Osvje≈æi</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="rowHead">
        <div class="big">üü° U≈ΩIVO</div>
        <div class="small" id="lastUpdate">‚Äî</div>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr><th>Vrijeme</th><th>Godi≈°te</th><th>Faza</th><th>Meƒç</th><th>Rezultat</th></tr>
          </thead>
          <tbody id="tbodyLive"><tr><td colspan="5" class="small">‚Äî</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="rowHead">
        <div class="big">‚ö™ SLEDEƒÜE</div>
        <div class="small">prvih 6</div>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr><th>Vrijeme</th><th>Godi≈°te</th><th>Faza</th><th>Meƒç</th></tr>
          </thead>
          <tbody id="tbodyNext"><tr><td colspan="4" class="small">‚Äî</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="rowHead">
      <div class="big">Kontrola terena</div>
      <div class="small">tv.html?teren=Teren%201&rotate=off | tv.html?rotate=on&interval=12</div>
    </div>
    <div id="terBtns" style="display:flex;gap:10px;flex-wrap:wrap"></div>
  </div>

  <div class="small" style="text-align:center;margin:14px 0;color:rgba(233,238,252,.55)">
    ¬© Mali fudbal ‚Ä¢ TV ekran
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://ayakstyzqrsjvrbfwgfs.supabase.co";
  const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_DZJST_2cQWJU89oXbyMipg_0O-dmc-l";
  const DEFAULT_TERENI = ["Teren 1","Teren 2","Teren 3","Teren 4"];
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

  const el = (id)=>document.getElementById(id);
  let ALL = [];
  let TERENI = [...DEFAULT_TERENI];
  let currentTeren = DEFAULT_TERENI[0];
  let rotateOn = true;
  let intervalSec = 15;
  let timer = null;

  function setConn(state){
    if(state==="ok"){ el("connDot").className="dot ok"; el("connText").textContent="Online"; }
    else if(state==="bad"){ el("connDot").className="dot bad"; el("connText").textContent="Gre≈°ka"; }
    else { el("connDot").className="dot"; el("connText").textContent="Spajam se‚Ä¶"; }
  }

  function fmtTime(v){
    if(!v) return "‚Äî";
    const d = new Date(v);
    if(isNaN(d)) return String(v);
    return d.toLocaleString("sr-ME",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  }

  function updateHeader(){
    el("terenTitle").textContent = `üèüÔ∏è ${currentTeren}`;
    el("terenSub").textContent = rotateOn ? `Rotacija ON ‚Ä¢ ${intervalSec}s` : `Fiksno ‚Ä¢ rotate OFF`;
  }

  function renderTerenButtons(){
    const wrap = el("terBtns");
    wrap.innerHTML = TERENI.map(t=>`
      <button class="btn ${t===currentTeren ? "primary" : ""}" data-t="${t}">${t}</button>
    `).join("");
    wrap.querySelectorAll("button").forEach(b=>{
      b.onclick=()=>{
        currentTeren = b.dataset.t;
        rotateOn = false;
        stopRotate();
        updateHeader();
        render();
      };
    });
  }

  function stopRotate(){ if(timer){ clearInterval(timer); timer=null; } }
  function startRotate(){
    if(!rotateOn) return;
    stopRotate();
    timer=setInterval(()=>{
      const idx = TERENI.indexOf(currentTeren);
      currentTeren = TERENI[(idx+1)%TERENI.length];
      updateHeader();
      render();
    }, intervalSec*1000);
  }

  function initFromURL(){
    const p = new URLSearchParams(location.search);
    const t = p.get("teren");
    if(t) currentTeren = t;

    const r = (p.get("rotate")||"on").toLowerCase();
    rotateOn = r !== "off";

    const i = parseInt(p.get("interval")||"",10);
    if(Number.isFinite(i) && i>=5 && i<=120) intervalSec = i;

    updateHeader();
  }

  async function load(){
    setConn("loading");
    const { data, error } = await sb.from("matches").select("*").order("vreme",{ascending:true});
    if(error){
      setConn("bad");
      el("tbodyLive").innerHTML = `<tr><td colspan="5" style="color:#ff4d6d;font-weight:800">${error.message}</td></tr>`;
      el("tbodyNext").innerHTML = `<tr><td colspan="4" class="small">‚Äî</td></tr>`;
      return;
    }
    setConn("ok");
    ALL = data || [];

    const terr = Array.from(new Set(ALL.map(x=>x.teren).filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b)));
    if(terr.length){
      TERENI = terr;
      if(!TERENI.includes(currentTeren)) currentTeren = TERENI[0];
    }
    el("lastUpdate").textContent = "A≈æurirano: " + new Date().toLocaleString("sr-ME");
    updateHeader();
    renderTerenButtons();
    render();
    startRotate();
  }

  function render(){
    const list = ALL.filter(x => String(x.teren||"") === String(currentTeren));
    const live = list.filter(x => (x.status||"")==="uzivo");
    const next = list.filter(x => (x.status||"")==="ceka").slice(0,6);

    el("tbodyLive").innerHTML = live.length ? live.map(r=>`
      <tr>
        <td>${fmtTime(r.vreme)}</td>
        <td><b>${r.godiste||""}</b></td>
        <td>${r.faza||""}</td>
        <td><b>${r.domacin||""}</b> vs <b>${r.gost||""}</b></td>
        <td class="score">${(r.gol_domacin??0)} : ${(r.gol_gost??0)}</td>
      </tr>
    `).join("") : `<tr><td colspan="5" class="small">Nema u≈æivo meƒçeva.</td></tr>`;

    el("tbodyNext").innerHTML = next.length ? next.map(r=>`
      <tr>
        <td>${fmtTime(r.vreme)}</td>
        <td><b>${r.godiste||""}</b></td>
        <td>${r.faza||""}</td>
        <td><b>${r.domacin||""}</b> vs <b>${r.gost||""}</b></td>
      </tr>
    `).join("") : `<tr><td colspan="4" class="small">Nema sledeƒáih meƒçeva.</td></tr>`;
  }

  sb.channel("matches-realtime-tv")
    .on("postgres_changes", { event:"*", schema:"public", table:"matches" }, () => load())
    .subscribe();

  el("btnRefresh").onclick=load;

  initFromURL();
  load();

  // PWA
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }
</script>
</body>
</html>
