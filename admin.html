<!doctype html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin – Mali fudbal</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial; margin:0; background:#f6f7fb;}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e7e7ee;border-radius:14px;padding:14px;margin:12px 0}
    input,select,button{padding:10px;border-radius:10px;border:1px solid #ddd;width:100%;font-size:16px}
    button{background:#111;color:#fff;border:none;cursor:pointer}
    button.secondary{background:#eee;color:#111}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .small{font-size:13px;color:#666}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .pill{padding:6px 10px;border-radius:999px;background:#eef; font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
    .muted{color:#777}
    .ok{color:green;font-weight:600}
    .err{color:#b00020;font-weight:600}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; white-space:pre-wrap;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h2 style="margin:10px 0">Admin – Rezultati</h2>
    <div id="statusPill" class="pill">Nisi ulogovan</div>
  </div>

  <div class="card" id="loginCard">
    <h3 style="margin:0 0 10px">Login</h3>
    <div class="row">
      <div>
        <label class="small">Email</label>
        <input id="email" type="email" placeholder="tvoj@email.com" />
      </div>
      <div>
        <label class="small">Password</label>
        <input id="password" type="password" placeholder="••••••••" />
      </div>
    </div>
    <div style="margin-top:10px" class="row">
      <button id="btnLogin" type="button">Uloguj se</button>
      <button id="btnLogout" type="button" class="secondary">Logout</button>
    </div>

    <div id="msg" style="margin-top:10px" class="small"></div>
    <div id="debug" style="margin-top:8px" class="small code muted"></div>
  </div>

  <div class="card" id="addCard" style="display:none">
    <h3 style="margin:0 0 10px">Dodaj utakmicu / rezultat</h3>

    <div class="row3">
      <div>
        <label class="small">Godište</label>
        <input id="godiste" placeholder="2016" />
      </div>
      <div>
        <label class="small">Grupa</label>
        <input id="grupa" placeholder="A" />
      </div>
      <div>
        <label class="small">Faza</label>
        <select id="faza">
          <option value="grupa">grupa</option>
          <option value="cetvrtfinale">četvrtfinale</option>
          <option value="polufinale">polufinale</option>
          <option value="finale">finale</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label class="small">Domaćin</label>
        <input id="domacin" placeholder="Dadeks" />
      </div>
      <div>
        <label class="small">Gost</label>
        <input id="gost" placeholder="Budućnost" />
      </div>
    </div>

    <div class="row3" style="margin-top:10px">
      <div>
        <label class="small">Gol domaćin</label>
        <input id="gol_domacin" type="number" min="0" placeholder="0" />
      </div>
      <div>
        <label class="small">Gol gost</label>
        <input id="gol_gost" type="number" min="0" placeholder="0" />
      </div>
      <div>
        <label class="small">Status</label>
        <select id="status">
          <option value="ceka">čeka</option>
          <option value="uzivo">uživo</option>
          <option value="gotovo">gotovo</option>
        </select>
      </div>
    </div>

    <button id="btnAdd" type="button" style="margin-top:12px">Sačuvaj</button>
    <div class="small muted" style="margin-top:8px">
      * Ovo radi samo kad si ulogovan (INSERT/UPDATE policy).
    </div>
  </div>

  <div class="card">
    <div class="top">
      <h3 style="margin:0">Utakmice</h3>
      <div class="small muted">klikni “Sačuvaj” pored reda za izmjenu (UPDATE)</div>
    </div>
    <div style="overflow:auto;margin-top:10px">
      <table>
        <thead>
          <tr>
            <th>Godište</th><th>Grupa</th><th>Faza</th><th>Meč</th><th>Rezultat</th><th>Status</th><th></th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7" class="muted">Učitavam…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- stabilniji CDN -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  // 1) OVDJE UBACI SVOJE PODATKE:
  const SUPABASE_URL = "PASTE_SUPABASE_URL";
  const SUPABASE_ANON_KEY = "PASTE_SUPABASE_ANON_KEY";

  // debug na prozoru
  window.SUPABASE_URL = SUPABASE_URL;

  const el = (id) => document.getElementById(id);
  const msg = (t, ok=true) => {
    el("msg").innerHTML = ok ? `<span class="ok">${t}</span>` : `<span class="err">${t}</span>`;
  };
  const dbg = (t) => { el("debug").textContent = t; };

  function shortKey(k){
    if(!k) return "";
    return k.slice(0, 12) + "..." + k.slice(-8);
  }

  // osnovna provjera
  (function bootChecks(){
    const checks = [];
    checks.push("supabase global: " + (typeof supabase));
    checks.push("SUPABASE_URL: " + (SUPABASE_URL || "MISSING"));
    checks.push("ANON_KEY: " + (SUPABASE_ANON_KEY ? shortKey(SUPABASE_ANON_KEY) : "MISSING"));
    dbg(checks.join("\n"));
  })();

  if(typeof supabase === "undefined"){
    msg("Greška: supabase-js nije učitan (CDN). Probaj drugi browser ili adblock off.", false);
  }

  const sb = (typeof supabase !== "undefined")
    ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    : null;

  async function refreshAuthUI(){
    if(!sb) return;
    const { data } = await sb.auth.getSession();
    const logged = !!data.session;
    el("addCard").style.display = logged ? "block" : "none";
    el("statusPill").textContent = logged ? "Ulogovan ✅" : "Nisi ulogovan";
  }

  async function loadMatches(){
    if(!sb) return;
    const { data, error } = await sb.from("matches").select("*").order("created_at", { ascending:false });

    const tb = el("tbody");
    if(error){
      tb.innerHTML = `<tr><td colspan="7" class="err">Greška SELECT: ${error.message}</td></tr>`;
      return;
    }
    if(!data || data.length === 0){
      tb.innerHTML = `<tr><td colspan="7" class="muted">Nema unosa još.</td></tr>`;
      return;
    }

    tb.innerHTML = data.map(r => `
      <tr data-id="${r.id}">
        <td>${r.godiste ?? ""}</td>
        <td>${r.grupa ?? ""}</td>
        <td>${r.faza ?? ""}</td>
        <td>${r.domacin ?? ""} <span class="muted">vs</span> ${r.gost ?? ""}</td>
        <td>
          <input style="width:70px" type="number" min="0" value="${r.gol_domacin ?? 0}" data-k="gol_domacin">
          :
          <input style="width:70px" type="number" min="0" value="${r.gol_gost ?? 0}" data-k="gol_gost">
        </td>
        <td>
          <select data-k="status" style="width:120px">
            ${["ceka","uzivo","gotovo"].map(s => `<option value="${s}" ${r.status===s?"selected":""}>${s}</option>`).join("")}
          </select>
        </td>
        <td><button data-action="save" type="button" style="padding:8px 10px;border-radius:10px">Sačuvaj</button></td>
      </tr>
    `).join("");
  }

  async function addMatch(){
    const payload = {
      godiste: el("godiste").value.trim(),
      grupa: el("grupa").value.trim(),
      faza: el("faza").value,
      domacin: el("domacin").value.trim(),
      gost: el("gost").value.trim(),
      gol_domacin: el("gol_domacin").value === "" ? null : Number(el("gol_domacin").value),
      gol_gost: el("gol_gost").value === "" ? null : Number(el("gol_gost").value),
      status: el("status").value
    };

    const { error } = await sb.from("matches").insert(payload);
    if(error){ msg("INSERT greška: " + error.message, false); return; }

    msg("Sačuvano ✅");
    ["domacin","gost","gol_domacin","gol_gost"].forEach(x => el(x).value = "");
    await loadMatches();
  }

  async function saveRow(tr){
    const id = tr.getAttribute("data-id");
    const gol_domacin = Number(tr.querySelector('[data-k="gol_domacin"]').value);
    const gol_gost = Number(tr.querySelector('[data-k="gol_gost"]').value);
    const status = tr.querySelector('[data-k="status"]').value;

    const { error } = await sb.from("matches").update({ gol_domacin, gol_gost, status }).eq("id", id);
    if(error){ msg("UPDATE greška: " + error.message, false); return; }
    msg("Update ✅");
  }

  // events
  el("btnLogin").addEventListener("click", async () => {
    try{
      if(!sb){ msg("Supabase nije inicijalizovan.", false); return; }

      const email = el("email").value.trim();
      const password = el("password").value;

      msg("Pokušavam login…");

      const { data, error } = await sb.auth.signInWithPassword({ email, password });

      if(error){
        msg("Login greška: " + error.message, false);
        return;
      }

      msg("Ulogovan ✅");
      await refreshAuthUI();
      await loadMatches();
      console.log("SESSION:", data);
    }catch(e){
      msg("Neočekivana greška: " + (e?.message || e), false);
      console.error(e);
    }
  });

  el("btnLogout").addEventListener("click", async () => {
    if(!sb) return;
    await sb.auth.signOut();
    msg("Izlogovan.");
    await refreshAuthUI();
  });

  el("btnAdd").addEventListener("click", addMatch);

  document.addEventListener("click", (e) => {
    const btn = e.target.closest('button[data-action="save"]');
    if(!btn) return;
    const tr = btn.closest("tr");
    saveRow(tr);
  });

  // realtime refresh
  if(sb){
    sb.channel("matches-realtime")
      .on("postgres_changes", { event:"*", schema:"public", table:"matches" }, () => loadMatches())
      .subscribe();
  }

  // init
  refreshAuthUI();
  loadMatches();
</script>
</body>
</html>
