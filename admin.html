<!doctype html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin – Mali fudbal</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial; margin:0; background:#f6f7fb;}
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e7e7ee;border-radius:14px;padding:14px;margin:12px 0}
    input,select,button,textarea{padding:10px;border-radius:10px;border:1px solid #ddd;width:100%;font-size:16px}
    textarea{min-height:40px;resize:vertical}
    button{background:#111;color:#fff;border:none;cursor:pointer}
    button.secondary{background:#eee;color:#111}
    button:disabled{opacity:.5;cursor:not-allowed}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
    @media(max-width:900px){ .row4{grid-template-columns:1fr 1fr} }
    .small{font-size:13px;color:#666}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;background:#eef; font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:14px;vertical-align:top}
    .muted{color:#777}
    .ok{color:green;font-weight:600}
    .err{color:#b00020;font-weight:600}
    .hint{background:#fff7d6;border:1px solid #ffe08a;padding:10px;border-radius:12px;margin-top:10px}
    .nowrap{white-space:nowrap}
    .mini{font-size:12px}
    .btnMini{padding:8px 10px;border-radius:10px}
    .saving{opacity:.7; pointer-events:none;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h2 style="margin:10px 0">Admin – Turnir (2015–2018)</h2>
    <div id="statusPill" class="pill">Provjera…</div>
  </div>

  <div class="card" id="loginCard">
    <h3 style="margin:0 0 10px">Login</h3>
    <div class="row">
      <div>
        <label class="small">Email</label>
        <input id="email" type="email" placeholder="tvoj@email.com" autocomplete="email"/>
      </div>
      <div>
        <label class="small">Password</label>
        <input id="password" type="password" placeholder="••••••••" autocomplete="current-password"/>
      </div>
    </div>
    <div style="margin-top:10px" class="row">
      <button id="btnLogin">Uloguj se</button>
      <button id="btnLogout" class="secondary">Logout</button>
    </div>

    <div id="msg" style="margin-top:10px" class="small"></div>

    <div class="hint small">
      <b>Ako update “vrati” rezultat</b> → znači UPDATE nije prošao u bazi (RLS ili session).<br/>
      Otvori stranicu sa <b>?nocache=1</b> i pogledaj Console (F12) – ovaj fajl sada ispisuje tačno sve.
    </div>
  </div>

  <div class="card" id="addCard">
    <h3 style="margin:0 0 10px">Dodaj utakmicu / rezultat</h3>

    <div class="row3">
      <div>
        <label class="small">Godište</label>
        <select id="godiste">
          <option value="2015">2015</option>
          <option value="2016" selected>2016</option>
          <option value="2017">2017</option>
          <option value="2018">2018</option>
        </select>
      </div>
      <div>
        <label class="small">Grupa</label>
        <input id="grupa" placeholder="A" />
      </div>
      <div>
        <label class="small">Faza</label>
        <select id="faza">
          <option value="grupa">grupa</option>
          <option value="cetvrtfinale">četvrtfinale</option>
          <option value="polufinale">polufinale</option>
          <option value="finale">finale</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label class="small">Domaćin</label>
        <input id="domacin" placeholder="Dadeks" />
      </div>
      <div>
        <label class="small">Gost</label>
        <input id="gost" placeholder="Budućnost" />
      </div>
    </div>

    <div class="row4" style="margin-top:10px">
      <div>
        <label class="small">Gol domaćin</label>
        <input id="gol_domacin" type="number" min="0" placeholder="0" />
      </div>
      <div>
        <label class="small">Gol gost</label>
        <input id="gol_gost" type="number" min="0" placeholder="0" />
      </div>
      <div>
        <label class="small">Status</label>
        <select id="status">
          <option value="ceka">čeka</option>
          <option value="uzivo">uživo</option>
          <option value="gotovo">gotovo</option>
        </select>
      </div>
      <div>
        <label class="small">Teren</label>
        <input id="teren" placeholder="Teren 1" />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label class="small">Vrijeme</label>
        <input id="vreme" type="datetime-local" />
        <div class="mini muted" style="margin-top:6px">Unosiš lokalno vrijeme.</div>
      </div>
      <div>
        <label class="small">Napomena</label>
        <input id="napomena" placeholder="npr. Kolo 1 / derbi" />
      </div>
    </div>

    <button id="btnAdd" style="margin-top:12px">Sačuvaj</button>
    <div id="addHint" class="small muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <div class="top">
      <h3 style="margin:0">Utakmice</h3>
      <div class="small muted">mijenjaš u redu pa klik “Sačuvaj” (UPDATE)</div>
    </div>
    <div style="overflow:auto;margin-top:10px">
      <table>
        <thead>
          <tr>
            <th class="nowrap">Vrijeme</th>
            <th>Teren</th>
            <th>Godište</th>
            <th>Grupa</th>
            <th>Faza</th>
            <th>Meč</th>
            <th>Rezultat</th>
            <th>Status</th>
            <th>Napomena</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="10" class="muted">Učitavam…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="small muted" style="text-align:center;margin:18px 0">
    Tip: na telefonu “Add to Home Screen” za brzi admin.
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://ayakstyzqrsjvrbfwgfs.supabase.co";
  const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_DZJST_2cQWJU89oXbyMipg_0O-dmc-l";
  const GODISTA = ["2015","2016","2017","2018"];

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

  const el = (id) => document.getElementById(id);

  function msg(text, ok=true){
    el("msg").innerHTML = ok ? `<span class="ok">${text}</span>` : `<span class="err">${text}</span>`;
  }

  function setAddEnabled(enabled){
    const addCard = el("addCard");
    addCard.querySelectorAll("input,select,button,textarea").forEach(x => x.disabled = !enabled);
    el("addHint").innerHTML = enabled
      ? `<span class="ok">Možeš dodavati i mijenjati utakmice ✅</span>`
      : `<span class="muted">Prvo se uloguj da bi dodavao (INSERT/UPDATE policy).</span>`;
  }

  function fmtTime(v){
    if(!v) return "—";
    const d = new Date(v);
    if(isNaN(d)) return String(v);
    return d.toLocaleString("sr-ME",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  }

  function toDateTimeLocalValue(v){
    if(!v) return "";
    const d = new Date(v);
    if(isNaN(d)) return "";
    const pad = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function fromDateTimeLocalInput(val){
    if(!val) return null;
    const d = new Date(val);
    if(isNaN(d)) return null;
    return d.toISOString();
  }

  async function getSessionOrNull(){
    try{
      const { data, error } = await sb.auth.getSession();
      if(error) throw error;
      return data.session || null;
    }catch(e){
      console.error("getSession error:", e);
      return null;
    }
  }

  async function refreshAuthUI(){
    const session = await getSessionOrNull();
    const logged = !!session;
    el("statusPill").textContent = logged ? "Ulogovan ✅" : "Nisi ulogovan";
    setAddEnabled(logged);

    console.log("AUTH session:", session ? { user: session.user?.id, email: session.user?.email } : null);
  }

  async function loadMatches(){
    const tb = el("tbody");
    tb.innerHTML = `<tr><td colspan="10" class="muted">Učitavam…</td></tr>`;

    const { data, error } = await sb
      .from("matches")
      .select("*")
      .order("vreme", { ascending:true })
      .order("created_at", { ascending:true });

    if(error){
      tb.innerHTML = `<tr><td colspan="10" class="err">Greška SELECT: ${error.message}</td></tr>`;
      console.error("SELECT error:", error);
      return;
    }

    if(!data || data.length === 0){
      tb.innerHTML = `<tr><td colspan="10" class="muted">Nema unosa još. Dodaj prvi meč gore ⬆️</td></tr>`;
      return;
    }

    tb.innerHTML = data.map(r => `
      <tr data-id="${r.id}">
        <td class="nowrap">
          <div class="mini muted">${fmtTime(r.vreme)}</div>
          <input type="datetime-local" data-k="vreme" value="${toDateTimeLocalValue(r.vreme)}">
        </td>
        <td><input data-k="teren" value="${(r.teren ?? "")}" placeholder="Teren 1"></td>
        <td class="nowrap">${r.godiste ?? ""}</td>
        <td class="nowrap">${r.grupa ?? ""}</td>
        <td class="nowrap">${r.faza ?? ""}</td>
        <td>${r.domacin ?? ""} <span class="muted">vs</span> ${r.gost ?? ""}</td>
        <td class="nowrap">
          <input style="width:72px;display:inline-block" type="number" min="0" value="${r.gol_domacin ?? 0}" data-k="gol_domacin">
          :
          <input style="width:72px;display:inline-block" type="number" min="0" value="${r.gol_gost ?? 0}" data-k="gol_gost">
        </td>
        <td>
          <select data-k="status" style="width:130px">
            ${["ceka","uzivo","gotovo"].map(s => `<option value="${s}" ${r.status===s?"selected":""}>${s}</option>`).join("")}
          </select>
        </td>
        <td><input data-k="napomena" value="${(r.napomena ?? "")}" placeholder="npr. derbi / kolo"></td>
        <td class="nowrap">
          <button class="btnMini" data-action="save">Sačuvaj</button>
        </td>
      </tr>
    `).join("");
  }

  async function addMatch(){
    const session = await getSessionOrNull();
    if(!session){
      msg("Nisi ulogovan (nema session). Login pa probaj opet.", false);
      return;
    }

    const godiste = el("godiste").value;
    if(!GODISTA.includes(String(godiste))) { msg("Godište mora biti 2015–2018.", false); return; }

    const payload = {
      godiste: String(godiste),
      grupa: el("grupa").value.trim(),
      faza: el("faza").value,
      domacin: el("domacin").value.trim(),
      gost: el("gost").value.trim(),
      gol_domacin: el("gol_domacin").value === "" ? null : Number(el("gol_domacin").value),
      gol_gost: el("gol_gost").value === "" ? null : Number(el("gol_gost").value),
      status: el("status").value,
      teren: el("teren").value.trim() || null,
      vreme: fromDateTimeLocalInput(el("vreme").value),
      napomena: el("napomena").value.trim() || null
    };

    console.log("INSERT payload:", payload);

    const { data: inserted, error } = await sb
      .from("matches")
      .insert(payload)
      .select("id")
      .single();

    if(error){
      msg("INSERT greška: " + error.message, false);
      console.error("INSERT error:", error);
      return;
    }

    msg("Sačuvano ✅ (ID: " + inserted.id + ")");
    ["domacin","gost","gol_domacin","gol_gost","napomena"].forEach(x => el(x).value = "");
    await loadMatches();
  }

  async function saveRow(tr){
    tr.classList.add("saving");

    try{
      const session = await getSessionOrNull();
      if(!session){
        msg("Nisi ulogovan (session = null). Ne može UPDATE.", false);
        console.error("UPDATE blocked: no session");
        return;
      }

      const id = tr.getAttribute("data-id");

      const gol_domacin_raw = tr.querySelector('[data-k="gol_domacin"]').value;
      const gol_gost_raw    = tr.querySelector('[data-k="gol_gost"]').value;

      const gol_domacin = gol_domacin_raw === "" ? null : parseInt(gol_domacin_raw, 10);
      const gol_gost    = gol_gost_raw === "" ? null : parseInt(gol_gost_raw, 10);

      const status   = tr.querySelector('[data-k="status"]').value;
      const teren    = tr.querySelector('[data-k="teren"]').value.trim() || null;
      const napomena = tr.querySelector('[data-k="napomena"]').value.trim() || null;
      const vreme    = fromDateTimeLocalInput(tr.querySelector('[data-k="vreme"]').value);

      const payload = { gol_domacin, gol_gost, status, teren, vreme, napomena };

      console.log("UPDATE try:", { id, payload, user: session.user?.id, email: session.user?.email });

      // 1) UPDATE
      const { data: updated, error: upErr } = await sb
        .from("matches")
        .update(payload)
        .eq("id", id)
        .select("id, gol_domacin, gol_gost, status, teren, vreme, napomena")
        .maybeSingle();

      if(upErr){
        msg("UPDATE greška: " + upErr.message, false);
        console.error("UPDATE error:", upErr);
        return;
      }

      if(!updated){
        msg("UPDATE nije promijenio red. (RLS policy ili ID mismatch)", false);
        console.error("UPDATE returned null row. Check RLS / id.");
        return;
      }

      // 2) HARD VERIFY (čitamo iz baze opet taj ID)
      const { data: verify, error: verErr } = await sb
        .from("matches")
        .select("id, gol_domacin, gol_gost, status")
        .eq("id", id)
        .single();

      if(verErr){
        msg("Update ✅ ali verify SELECT greška: " + verErr.message, false);
        console.error("VERIFY error:", verErr);
        return;
      }

      msg(`Update ✅ (Baza: ${verify.gol_domacin}:${verify.gol_gost}, ${verify.status})`);
      console.log("UPDATE OK / VERIFY:", verify);

      await loadMatches(); // sad refresh tek kad znamo da je DB stvarno promijenjen
    } finally {
      tr.classList.remove("saving");
    }
  }

  el("btnLogin").addEventListener("click", async () => {
    const email = el("email").value.trim();
    const password = el("password").value;

    const { data, error } = await sb.auth.signInWithPassword({ email, password });

    if(error){
      msg("Login greška: " + error.message, false);
      console.error("LOGIN error:", error);
      return;
    }

    console.log("LOGIN OK:", data);
    msg("Ulogovan ✅");
    await refreshAuthUI();
    await loadMatches();
  });

  el("btnLogout").addEventListener("click", async () => {
    await sb.auth.signOut();
    msg("Izlogovan.");
    await refreshAuthUI();
    await loadMatches();
  });

  el("btnAdd").addEventListener("click", addMatch);

  document.addEventListener("click", (e) => {
    const btn = e.target.closest('button[data-action="save"]');
    if(!btn) return;
    const tr = btn.closest("tr");
    saveRow(tr);
  });

  // START
  refreshAuthUI();
  loadMatches();
</script>
</body>
</html>
