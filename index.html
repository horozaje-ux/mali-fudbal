<!doctype html>
<html lang="sr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mali fudbal â€“ Turnir Live</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#0b1020">

<style>
body{margin:0;font-family:system-ui;background:#070a14;color:#e9eefc}
.wrap{max-width:1200px;margin:auto;padding:16px}
.card{background:rgba(255,255,255,.06);border-radius:16px;padding:14px;margin-top:14px}
button{padding:8px 14px;border-radius:999px;border:none;cursor:pointer}
.tab{border:1px solid rgba(255,255,255,.15);background:none;color:#fff}
.tab.active{background:#4f7cff}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.1)}
.score{font-weight:900}
</style>
</head>

<body>
<div class="wrap">
<h2>Mali fudbal â€“ Turnir</h2>

<div>
<button class="tab active" data-tab="live">Live</button>
<button class="tab" data-tab="grupe">Grupe</button>
<button class="tab" data-tab="elim">Eliminacije</button>
</div>

<div id="live" class="card"></div>
<div id="grupe" class="card" style="display:none"></div>
<div id="elim" class="card" style="display:none"></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL="https://ayakstyzqrsjvrbfwgfs.supabase.co";
const SUPABASE_KEY="sb_publishable_DZJST_2cQWJU89oXbyMipg_0O-dmc-l";
const GODISTA=["2015","2016","2017","2018"];
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let ALL=[];

// TABOVI
document.querySelectorAll(".tab").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    ["live","grupe","elim"].forEach(id=>{
      document.getElementById(id).style.display =
        b.dataset.tab===id?"block":"none";
    });
  };
});

// TABELA
function computeStandings(matches){
  const t={};
  const g=n=>t[n]||(t[n]={team:n,P:0,W:0,D:0,L:0,GF:0,GA:0,PTS:0});
  matches.forEach(m=>{
    if(m.status!=="gotovo")return;
    const A=g(m.domacin),B=g(m.gost);
    A.P++;B.P++;
    A.GF+=m.gol_domacin;A.GA+=m.gol_gost;
    B.GF+=m.gol_gost;B.GA+=m.gol_domacin;
    if(m.gol_domacin>m.gol_gost){A.W++;A.PTS+=3;B.L++;}
    else if(m.gol_domacin<m.gol_gost){B.W++;B.PTS+=3;A.L++;}
    else{A.D++;B.D++;A.PTS++;B.PTS++;}
  });
  return Object.values(t).sort((a,b)=>b.PTS-a.PTS||(b.GF-b.GA)-(a.GF-a.GA));
}

// AUTOMATSKI ÄŒETVRTFINALE
async function autoGenerateQuarterFinals(){
  const insert=[];
  GODISTA.forEach(g=>{
    const groupMatches=ALL.filter(x=>x.godiste==g&&x.faza=="grupa");
    const groups={};
    groupMatches.forEach(m=>{
      if(!groups[m.grupa])groups[m.grupa]=[];
      groups[m.grupa].push(m);
    });
    if(!groups.A||!groups.B)return;

    const A=computeStandings(groups.A);
    const B=computeStandings(groups.B);
    if(A.length<2||B.length<2)return;

    [
      {h:A[0].team,a:B[1].team},
      {h:B[0].team,a:A[1].team}
    ].forEach(p=>{
      const ex=ALL.find(x=>
        x.godiste==g&&x.faza=="cetvrtfinale"&&
        x.domacin==p.h&&x.gost==p.a
      );
      if(!ex){
        insert.push({
          godiste:g,
          faza:"cetvrtfinale",
          domacin:p.h,
          gost:p.a,
          status:"ceka",
          auto_generated:true
        });
      }
    });
  });
  if(insert.length) await sb.from("matches").insert(insert);
}

// RENDER
function render(){
  document.getElementById("live").innerHTML =
    "<h3>Live utakmice</h3>" +
    ALL.filter(x=>x.status!=="ceka").map(m=>
      `<div>${m.domacin} ${m.gol_domacin}:${m.gol_gost} ${m.gost}</div>`
    ).join("");

  document.getElementById("grupe").innerHTML =
    "<h3>Grupe</h3>" +
    GODISTA.map(g=>{
      const m=ALL.filter(x=>x.godiste==g&&x.faza=="grupa");
      const A=computeStandings(m.filter(x=>x.grupa=="A"));
      const B=computeStandings(m.filter(x=>x.grupa=="B"));
      return `<b>${g}</b><br>
      A: ${A.map(t=>t.team).join(", ")}<br>
      B: ${B.map(t=>t.team).join(", ")}`;
    }).join("<hr>");

  document.getElementById("elim").innerHTML =
    "<h3>ÄŒetvrtfinale</h3>" +
    ALL.filter(x=>x.faza=="cetvrtfinale").map(m=>
      `<div>${m.domacin} ðŸ†š ${m.gost}</div>`
    ).join("");
}

// LOAD
async function load(){
  const {data}=await sb.from("matches").select("*");
  ALL=data||[];
  await autoGenerateQuarterFinals();
  render();
}
load();

// PWA
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("./sw.js");
}
</script>
</body>
</html>
