<!doctype html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mali fudbal ‚Äì Turnir Live</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0b1020">

  <style>
    :root{
      --bg:#070a14; --card:rgba(255,255,255,.06); --card2:rgba(255,255,255,.10);
      --text:#e9eefc; --muted:rgba(233,238,252,.70); --line:rgba(255,255,255,.12);
      --ok:#27e38a; --warn:#ffcc66; --bad:#ff4d6d; --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 450px at 15% 15%, rgba(70,120,255,.28), transparent 60%),
        radial-gradient(800px 400px at 85% 10%, rgba(255,90,180,.22), transparent 55%),
        radial-gradient(900px 500px at 50% 90%, rgba(40,255,160,.12), transparent 55%),
        linear-gradient(180deg, #050817, #070a14 55%, #050714);
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0 14px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg, rgba(70,120,255,.9), rgba(255,90,180,.85));display:grid;place-items:center;font-weight:900}
    .brand h1{margin:0;font-size:18px;line-height:1.1}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    a.btn, button.btn{
      appearance:none;border:1px solid var(--line);background:var(--card);color:var(--text);text-decoration:none;
      padding:10px 12px;border-radius:14px;display:inline-flex;align-items:center;gap:8px;cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,.25);transition:.15s transform,.15s background,.15s border;font-size:13px
    }
    a.btn:hover, button.btn:hover{transform:translateY(-1px);background:var(--card2);border-color:rgba(255,255,255,.18)}
    .btn.primary{background:linear-gradient(135deg, rgba(70,120,255,.75), rgba(255,90,180,.55));border-color:rgba(255,255,255,.15)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn);box-shadow:0 0 0 4px rgba(255,204,102,.15)}
    .dot.ok{background:var(--ok);box-shadow:0 0 0 4px rgba(39,227,138,.14)}
    .dot.bad{background:var(--bad);box-shadow:0 0 0 4px rgba(255,77,109,.14)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px}
    .tab{padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.05);cursor:pointer;font-size:13px}
    .tab.active{background:linear-gradient(135deg, rgba(70,120,255,.55), rgba(255,90,180,.35));border-color:rgba(255,255,255,.16)}
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    select,input{
      width:100%; padding:11px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:var(--text);outline:none
    }
    .filters>*{flex:1 1 160px}
    .small{font-size:12px;color:var(--muted)}
    .sectionTitle{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:10px 2px 10px;flex-wrap:wrap}
    .tableWrap{overflow:auto;border-radius:16px;border:1px solid rgba(255,255,255,.10)}
    table{width:100%;border-collapse:collapse;min-width:860px}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:13px}
    th{color:rgba(233,238,252,.75);font-weight:700}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);font-size:12px;white-space:nowrap}
    .tag.live{border-color:rgba(255,204,102,.35);background:rgba(255,204,102,.12)}
    .tag.done{border-color:rgba(39,227,138,.35);background:rgba(39,227,138,.12)}
    .tag.wait{border-color:rgba(233,238,252,.20);background:rgba(233,238,252,.07)}
    .score{font-weight:900}
    .muted{color:var(--muted)}
    .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.twoCol{grid-template-columns:1fr}}
    .bracket{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:900px){.bracket{grid-template-columns:1fr}}
    .matchCard{padding:12px;border-radius:16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10)}
    .matchRow{display:flex;justify-content:space-between;gap:10px;margin:6px 0}
    .footer{margin:18px 0 6px;text-align:center;color:var(--muted);font-size:12px}
    .genbar{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 14px}
    .chip{padding:9px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.05);cursor:pointer;font-size:13px}
    .chip.active{background:linear-gradient(135deg, rgba(40,255,160,.18), rgba(70,120,255,.22));border-color:rgba(255,255,255,.16)}

    /* ===== Sponsor footer (ispravljeno, vidljivo) ===== */
    .sponsors-footer{
      margin: 18px 0 6px;
      padding: 14px 0 6px;
      border-top: 1px solid rgba(255,255,255,.08);
      text-align:center;
    }
    .sponsors-wrap{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .sponsor-label{
      font-size:12px;
      letter-spacing:1px;
      color: rgba(233,238,252,.55);
    }
    .sponsor-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 220px;
      height: 64px;
      padding: 8px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow:0 10px 22px rgba(0,0,0,.25);
      text-decoration:none;
      overflow:hidden;
    }
    .sponsor-logo{
      height: 140px;      /* namjerno veƒáe od badge-a */
      width: auto;
      transform: scale(1.15);
      display:block;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">MF</div>
        <div>
          <h1 style="margin:0">Mali fudbal ‚Äì Turnir</h1>
          <div class="sub">2015 ‚Ä¢ 2016 ‚Ä¢ 2017 ‚Ä¢ 2018 ‚Äî Grupe ‚Ä¢ Raspored ‚Ä¢ Nokaut ‚Ä¢ Live</div>
        </div>
      </div>

      <div class="btns">
        <span class="pill"><span class="dot" id="connDot"></span><span id="connText">Spajam se‚Ä¶</span></span>
        <a class="btn" href="./tv.html">üì∫ TV</a>
        <a class="btn primary" href="./admin.html">‚öôÔ∏è Admin</a>
        <button class="btn" id="btnRefresh">üîÑ Osvje≈æi</button>
      </div>
    </div>

    <!-- Generacije + global search -->
    <div class="card" style="padding:12px;margin-bottom:14px">
      <div class="sectionTitle" style="margin:0 0 8px">
        <b>Generacije</b>
        <span class="small" id="lastUpdate">‚Äî</span>
      </div>

      <div class="genbar" id="genBar"></div>

      <div class="filters" style="margin-top:8px">
        <input id="globalSearch" placeholder="Pretra≈æi tim (npr. Dadeks) ‚Üí vidi raspored, teren i vrijeme" />
        <button class="btn" id="btnClearSearch" style="flex:0 0 auto">‚úñ Obri≈°i</button>
      </div>

      <div class="tableWrap" style="margin-top:12px">
        <table>
          <thead>
            <tr>
              <th>Godi≈°te</th><th>Vrijeme</th><th>Teren</th><th>Faza</th><th>Grupa</th><th>Meƒç</th><th>Rezultat</th><th>Status</th>
            </tr>
          </thead>
          <tbody id="tbodySearch">
            <tr><td colspan="8" class="muted">Ukucaj tim gore (npr. Dadeks) da vidi≈° sve utakmice tog tima.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="small muted" style="margin-top:8px">
        Napomena: pretraga radi i bez kvaƒçica (Buduƒánost / Buducnost).
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="live">üî• Live</button>
      <button class="tab" data-tab="raspored">üóìÔ∏è Raspored</button>
      <button class="tab" data-tab="grupe">üìä Grupe</button>
      <button class="tab" data-tab="elim">üèÜ Nokaut</button>
    </div>

    <!-- LIVE -->
    <div id="tab-live" class="card">
      <div class="sectionTitle">
        <b>Live / Sve utakmice</b>
        <span class="small" id="lockInfo">‚Äî</span>
      </div>

      <div class="filters">
        <select id="fGrupa"><option value="">Sve grupe</option></select>
        <select id="fFaza">
          <option value="">Sve faze</option>
          <option value="grupa">grupa</option>
          <option value="cetvrtfinale">ƒçetvrtfinale</option>
          <option value="polufinale">polufinale</option>
          <option value="finale">finale</option>
        </select>
        <select id="fStatus">
          <option value="">Svi statusi</option>
          <option value="ceka">ƒçeka</option>
          <option value="uzivo">u≈æivo</option>
          <option value="gotovo">gotovo</option>
        </select>
        <input id="fSearch" placeholder="Pretraga (Dadeks, Buduƒánost‚Ä¶)" />
      </div>

      <div class="tableWrap" style="margin-top:12px">
        <table>
          <thead>
            <tr>
              <th>Vrijeme</th><th>Teren</th><th>Godi≈°te</th><th>Grupa</th><th>Faza</th><th>Meƒç</th><th>Rezultat</th><th>Status</th>
            </tr>
          </thead>
          <tbody id="tbodyLive"><tr><td colspan="8" class="muted">Uƒçitavam‚Ä¶</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- RASPORED (PROSTO: bez grupisanja po terenu) -->
    <div id="tab-raspored" class="card" style="display:none;margin-top:14px">
      <div class="sectionTitle">
        <b>Raspored</b>
        <span class="small">odabrano godi≈°te gore</span>
      </div>

      <div class="filters">
        <select id="rTeren"><option value="">Svi tereni</option></select>
        <select id="rDan"><option value="">Svi dani</option></select>
        <select id="rFaza"><option value="">Sve faze</option></select>
      </div>

      <div class="tableWrap" style="margin-top:12px">
        <table>
          <thead>
            <tr>
              <th>Vrijeme</th><th>Teren</th><th>Faza</th><th>Grupa</th><th>Meƒç</th><th>Status</th>
            </tr>
          </thead>
          <tbody id="tbodyRaspored"><tr><td colspan="6" class="muted">Uƒçitavam‚Ä¶</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- GRUPE -->
    <div id="tab-grupe" class="card" style="display:none;margin-top:14px">
      <div class="sectionTitle">
        <b>Tabele grupa</b>
        <span class="small">odabrano godi≈°te gore ‚Ä¢ raƒçuna se iz ‚Äúgrupa‚Äù</span>
      </div>

      <div class="filters">
        <select id="gGrupa"><option value="">Sve grupe</option></select>
      </div>

      <div id="groupsWrap" style="margin-top:12px" class="twoCol"></div>
    </div>

    <!-- NOKAUT -->
    <div id="tab-elim" class="card" style="display:none;margin-top:14px">
      <div class="sectionTitle">
        <b>Nokaut</b>
        <span class="small">odabrano godi≈°te gore ‚Ä¢ automatski prikaz (admin potvrƒëuje)</span>
      </div>

      <div class="bracket" style="margin-top:12px">
        <div class="card" style="padding:12px">
          <b>ƒåetvrtfinale</b>
          <div id="qfWrap" style="display:grid;gap:10px;margin-top:10px"></div>
        </div>
        <div class="card" style="padding:12px">
          <b>Polufinale</b>
          <div id="sfWrap" style="display:grid;gap:10px;margin-top:10px"></div>
        </div>
        <div class="card" style="padding:12px">
          <b>Finale</b>
          <div id="fWrap" style="display:grid;gap:10px;margin-top:10px"></div>
        </div>
      </div>

      <div class="small muted" style="margin-top:12px">
        ‚ö†Ô∏è Nokaut meƒçevi ne smiju zavr≈°iti nerije≈°eno. Ako je 1:1, upi≈°i pobjednika (npr. 2:1).
      </div>
    </div>

    <!-- ===== Sponsor + Footer ===== -->
    <footer class="sponsors-footer">
      <div class="sponsors-wrap">
        <span class="sponsor-label">SPONZOR</span>
        <a class="sponsor-badge" href="https://sansabet.com" target="_blank" rel="noopener">
          <img class="sponsor-logo" src="./1111111111111111111111111111111111111111111111.png?v=2" alt="≈†ansabet.com" />
        </a>
      </div>
      <div class="footer">¬© Mali fudbal ‚Ä¢ Live sistem</div>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://ayakstyzqrsjvrbfwgfs.supabase.co";
    const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_DZJST_2cQWJU89oXbyMipg_0O-dmc-l";

    // Generacije (fiksno)
    const GODISTA = ["2015","2016","2017","2018"];

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);
    const el = (id)=>document.getElementById(id);

    let ALL = [];
    let activeGodiste = "2016";

    // ===== Query params (tab + godiste) =====
    function getQS(){
      const p = new URLSearchParams(location.search);
      return {
        tab: (p.get("tab") || "").toLowerCase(),
        godiste: (p.get("godiste") || "").trim()
      };
    }
    function setQS(tabName){
      const p = new URLSearchParams(location.search);
      p.set("tab", tabName);
      p.set("godiste", String(activeGodiste));
      history.replaceState({}, "", location.pathname + "?" + p.toString());
    }
    function applyQS(){
      const { tab, godiste } = getQS();
      if (godiste && GODISTA.includes(String(godiste))) activeGodiste = String(godiste);

      const map = { live:"live", raspored:"raspored", grupe:"grupe", elim:"elim", eliminacije:"elim", nokaut:"elim" };
      const t = map[tab];
      if (t) showTab(t);
    }

    function setConn(state){
      const dot = el("connDot");
      const text = el("connText");
      if(state==="ok"){ dot.className="dot ok"; text.textContent="Online"; }
      else if(state==="bad"){ dot.className="dot bad"; text.textContent="Gre≈°ka"; }
      else { dot.className="dot"; text.textContent="Spajam se‚Ä¶"; }
    }

    function tagStatus(s){
      if(s==="uzivo") return `<span class="tag live">üü° u≈æivo</span>`;
      if(s==="gotovo") return `<span class="tag done">üü¢ gotovo</span>`;
      return `<span class="tag wait">‚ö™ ƒçeka</span>`;
    }

    function fmtTime(v){
      if(!v) return "‚Äî";
      const d = new Date(v);
      if(isNaN(d)) return String(v);
      return d.toLocaleString("sr-ME",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    }

    function dayKey(v){
      if(!v) return "";
      const d = new Date(v);
      if(isNaN(d)) return "";
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function dayLabel(key){
      if(!key) return "";
      const d = new Date(key + "T00:00:00");
      if(isNaN(d)) return key;
      return d.toLocaleDateString("sr-ME",{year:"numeric",month:"2-digit",day:"2-digit"});
    }

    function normalize(s){
      return (s||"")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .trim();
    }

    // Generacije bar
    function buildGenBar(){
      const bar = el("genBar");
      bar.innerHTML = GODISTA.map(g => `
        <button class="chip ${String(g)===String(activeGodiste) ? "active" : ""}" data-g="${g}">
          ${g}
        </button>
      `).join("");

      bar.querySelectorAll(".chip").forEach(b=>{
        b.addEventListener("click", ()=>{
          activeGodiste = b.getAttribute("data-g");
          buildGenBar();
          fillSelectsFromActive();
          renderAll();
          renderGlobalSearch();
          setQS(currentTab());
        });
      });
    }

    function currentTab(){
      const b = document.querySelector(".tab.active");
      return b ? (b.getAttribute("data-tab") || "live") : "live";
    }

    function activeList(){
      return ALL.filter(x => String(x.godiste||"") === String(activeGodiste));
    }

    function uniq(arr){
      return Array.from(new Set(arr.filter(v => v !== null && v !== undefined && String(v).trim() !== "")));
    }

    function setOptionsKeep(selectId, values, firstLabel, mapLabelFn){
      const sel = el(selectId);
      const prev = sel.value;
      sel.innerHTML =
        `<option value="">${firstLabel}</option>` +
        values.map(v => {
          const label = mapLabelFn ? mapLabelFn(v) : v;
          return `<option value="${v}">${label}</option>`;
        }).join("");
      if([ "", ...values.map(String) ].includes(String(prev))) sel.value = prev;
    }

    function fillSelectsFromActive(){
      const list = activeList();
      const grupe = uniq(list.map(x=>x.grupa)).map(String).sort();
      const tereni = uniq(list.map(x=>x.teren)).map(String).sort();
      const dani = uniq(list.map(x=>dayKey(x.vreme))).sort();
      const faze = uniq(list.map(x=>x.faza)).map(String).sort();

      setOptionsKeep("fGrupa", grupe, "Sve grupe");
      setOptionsKeep("gGrupa", grupe, "Sve grupe");

      setOptionsKeep("rTeren", tereni, "Svi tereni");
      setOptionsKeep("rDan", dani, "Svi dani", (k)=>dayLabel(k));
      setOptionsKeep("rFaza", faze, "Sve faze");
    }

    // ===== Standings =====
    function computeStandings(matches){
      const teams = {};
      function ensure(name){
        if(!teams[name]) teams[name] = { team:name, P:0,W:0,D:0,L:0,GF:0,GA:0,GD:0,PTS:0 };
        return teams[name];
      }

      for(const m of matches){
        const a = (m.domacin||"").trim();
        const b = (m.gost||"").trim();
        if(!a || !b) continue;

        const ga = Number(m.gol_domacin ?? 0);
        const gb = Number(m.gol_gost ?? 0);
        if((m.status||"") !== "gotovo" && (m.gol_domacin==null || m.gol_gost==null)) continue;

        const A = ensure(a);
        const B = ensure(b);

        A.P++; B.P++;
        A.GF += ga; A.GA += gb;
        B.GF += gb; B.GA += ga;

        if(ga > gb){ A.W++; A.PTS+=3; B.L++; }
        else if(ga < gb){ B.W++; B.PTS+=3; A.L++; }
        else { A.D++; B.D++; A.PTS+=1; B.PTS+=1; }
      }

      const list = Object.values(teams).map(t=> ({...t, GD: (t.GF - t.GA)}));
      list.sort((x,y)=>(y.PTS-x.PTS)||(y.GD-x.GD)||(y.GF-x.GF)||x.team.localeCompare(y.team));
      return list;
    }

    // ===== Lock info =====
    function groupsLockedForActive(){
      return ALL.some(m =>
        String(m.godiste||"")===String(activeGodiste) &&
        ["cetvrtfinale","polufinale","finale"].includes(m.faza||"")
      );
    }
    function renderLockInfo(){
      const locked = groupsLockedForActive();
      el("lockInfo").innerHTML = locked
        ? `<span class="tag done">üîí Grupe zakljuƒçane (postoji nokaut)</span>`
        : `<span class="tag wait">üîì Grupe otvorene</span>`;
    }

    // ===== Live =====
    function renderLive(){
      const grp = el("fGrupa").value.trim();
      const faza = el("fFaza").value.trim();
      const st = el("fStatus").value.trim();
      const q = normalize(el("fSearch").value);

      let list = [...activeList()];
      if(grp) list = list.filter(x=>String(x.grupa||"")===grp);
      if(faza) list = list.filter(x=>(x.faza||"")===faza);
      if(st) list = list.filter(x=>(x.status||"")===st);
      if(q){
        list = list.filter(x =>
          normalize(x.domacin).includes(q) ||
          normalize(x.gost).includes(q) ||
          normalize(x.faza).includes(q) ||
          normalize(x.grupa).includes(q) ||
          normalize(x.teren).includes(q) ||
          normalize(x.napomena).includes(q)
        );
      }

      const tb = el("tbodyLive");
      if(!list.length){
        tb.innerHTML = `<tr><td colspan="8" class="muted">Nema utakmica za filter.</td></tr>`;
        return;
      }

      tb.innerHTML = list.map(r=>`
        <tr>
          <td>${fmtTime(r.vreme)}</td>
          <td>${r.teren ?? "‚Äî"}</td>
          <td>${r.godiste ?? ""}</td>
          <td>${r.grupa ?? ""}</td>
          <td>${r.faza ?? ""}</td>
          <td><b>${r.domacin ?? ""}</b> <span class="muted">vs</span> <b>${r.gost ?? ""}</b></td>
          <td class="score">${(r.gol_domacin ?? 0)} : ${(r.gol_gost ?? 0)}</td>
          <td>${tagStatus(r.status)}</td>
        </tr>
      `).join("");
    }

    // ===== Raspored (prosto: jedna lista) =====
    function renderRaspored(){
      const teren = el("rTeren").value.trim();
      const dan = el("rDan").value.trim();
      const faza = el("rFaza").value.trim();

      let list = [...activeList()].sort((a,b)=> {
        const ta = a.vreme ? new Date(a.vreme).getTime() : 0;
        const tb = b.vreme ? new Date(b.vreme).getTime() : 0;
        return ta - tb;
      });

      if(teren) list = list.filter(x=>(x.teren||"")===teren);
      if(dan) list = list.filter(x=>dayKey(x.vreme)===dan);
      if(faza) list = list.filter(x=>(x.faza||"")===faza);

      const tbod = el("tbodyRaspored");
      if(!list.length){
        tbod.innerHTML = `<tr><td colspan="6" class="muted">Nema utakmica u rasporedu za filter.</td></tr>`;
        return;
      }

      tbod.innerHTML = list.map(r=>`
        <tr>
          <td>${fmtTime(r.vreme)}</td>
          <td>${r.teren ?? "‚Äî"}</td>
          <td>${r.faza ?? ""}</td>
          <td>${r.grupa ?? ""}</td>
          <td><b>${r.domacin ?? ""}</b> <span class="muted">vs</span> <b>${r.gost ?? ""}</b></td>
          <td>${tagStatus(r.status)}</td>
        </tr>
      `).join("");
    }

    // ===== Grupe =====
    function renderGrupe(){
      const grpFilter = el("gGrupa").value.trim();
      let base = activeList().filter(x => (x.faza||"") === "grupa");
      if(grpFilter) base = base.filter(x => String(x.grupa||"") === grpFilter);

      const map = new Map();
      for(const m of base){
        const key = `${m.godiste||""}__${m.grupa||""}`;
        if(!map.has(key)) map.set(key, []);
        map.get(key).push(m);
      }

      const wrap = el("groupsWrap");
      const keys = Array.from(map.keys()).sort();
      if(!keys.length){
        wrap.innerHTML = `<div class="muted">Nema grupnih utakmica (faza = grupa) za godi≈°te ${activeGodiste}.</div>`;
        return;
      }

      wrap.innerHTML = keys.map(k=>{
        const [god,grp] = k.split("__");
        const standings = computeStandings(map.get(k));

        return `
          <div class="card" style="padding:12px">
            <div class="sectionTitle" style="margin:0 0 8px">
              <b>Godi≈°te ${god} ‚Ä¢ Grupa ${grp}</b>
              <span class="small">PTS / GD / GF</span>
            </div>
            <div class="tableWrap">
              <table style="min-width:520px">
                <thead>
                  <tr>
                    <th>#</th><th>Tim</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>PTS</th>
                  </tr>
                </thead>
                <tbody>
                  ${standings.length ? standings.map((t,i)=>`
                    <tr>
                      <td>${i+1}</td>
                      <td><b>${t.team}</b></td>
                      <td>${t.P}</td><td>${t.W}</td><td>${t.D}</td><td>${t.L}</td>
                      <td>${t.GF}</td><td>${t.GA}</td><td>${t.GD}</td><td class="score">${t.PTS}</td>
                    </tr>
                  `).join("") : `<tr><td colspan="10" class="muted">Nema odigranih meƒçeva.</td></tr>`}
                </tbody>
              </table>
            </div>
            <div class="small" style="margin-top:8px">Sort: bodovi, gol-razlika, dati golovi.</div>
          </div>
        `;
      }).join("");
    }

    // ===== Nokaut (READ from DB + fallback preview) =====
    function matchMini(r){
      return `
        <div class="matchCard">
          <div class="small muted">${fmtTime(r.vreme)} ‚Ä¢ ${r.teren ?? "‚Äî"} ${r.napomena ? "‚Ä¢ " + r.napomena : ""}</div>
          <div class="matchRow"><b>${r.domacin ?? ""}</b><span class="score">${(r.gol_domacin ?? 0)}</span></div>
          <div class="matchRow"><b>${r.gost ?? ""}</b><span class="score">${(r.gol_gost ?? 0)}</span></div>
          <div style="margin-top:6px">${tagStatus(r.status)}</div>
        </div>
      `;
    }

    function buildKnockoutPreviewForActive(){
      const baseGroup = activeList().filter(m => (m.faza||"")==="grupa");

      const groups = {};
      for(const m of baseGroup){
        const g = String(m.grupa||"").trim();
        if(!g) continue;
        if(!groups[g]) groups[g] = [];
        groups[g].push(m);
      }

      const groupNames = Object.keys(groups).sort();
      if(groupNames.length < 2) return { qf:[], sf:[], fin:[] };

      const standingsByGroup = {};
      for(const g of groupNames) standingsByGroup[g] = computeStandings(groups[g]);

      const allHave2 = groupNames.every(g => (standingsByGroup[g]||[]).length >= 2);
      if(!allHave2) return { qf:[], sf:[], fin:[] };

      if(groupNames.length === 2){
        const A = standingsByGroup[groupNames[0]];
        const B = standingsByGroup[groupNames[1]];
        const sf = [
          { faza:"polufinale", domacin:A[0].team, gost:B[1].team, napomena:"SF1", status:"ceka" },
          { faza:"polufinale", domacin:B[0].team, gost:A[1].team, napomena:"SF2", status:"ceka" }
        ];
        return { qf:[], sf, fin:[] };
      }

      const G = groupNames.slice(0,4);
      const A = standingsByGroup[G[0]], B = standingsByGroup[G[1]], C = standingsByGroup[G[2]], D = standingsByGroup[G[3]];

      const qf = [
        { faza:"cetvrtfinale", domacin:A[0].team, gost:B[1].team, napomena:"QF1", status:"ceka" },
        { faza:"cetvrtfinale", domacin:B[0].team, gost:A[1].team, napomena:"QF2", status:"ceka" },
        { faza:"cetvrtfinale", domacin:C[0].team, gost:D[1].team, napomena:"QF3", status:"ceka" },
        { faza:"cetvrtfinale", domacin:D[0].team, gost:C[1].team, napomena:"QF4", status:"ceka" }
      ];

      return { qf, sf:[], fin:[] };
    }

    function renderElim(){
      const list = [...activeList()].filter(x => ["cetvrtfinale","polufinale","finale"].includes(x.faza||""));
      const qf = list.filter(x=>(x.faza||"")==="cetvrtfinale");
      const sf = list.filter(x=>(x.faza||"")==="polufinale");
      const fin = list.filter(x=>(x.faza||"")==="finale");

      if(!qf.length && !sf.length && !fin.length){
        const prev = buildKnockoutPreviewForActive();
        el("qfWrap").innerHTML = prev.qf.length ? prev.qf.map(matchMini).join("") : `<div class="muted">Nema ƒçetvrtfinala (jo≈°).</div>`;
        el("sfWrap").innerHTML = prev.sf.length ? prev.sf.map(matchMini).join("") : `<div class="muted">Nema polufinala (preview kad su 2 grupe).</div>`;
        el("fWrap").innerHTML = `<div class="muted">Finale se pojavi kad admin potvrdi / unese nokaut.</div>`;
        return;
      }

      el("qfWrap").innerHTML = qf.length ? qf.map(matchMini).join("") : `<div class="muted">Nema ƒçetvrtfinala.</div>`;
      el("sfWrap").innerHTML = sf.length ? sf.map(matchMini).join("") : `<div class="muted">Nema polufinala.</div>`;
      el("fWrap").innerHTML = fin.length ? fin.map(matchMini).join("") : `<div class="muted">Nema finala.</div>`;
    }

    // ===== Global search =====
    function renderGlobalSearch(){
      const q = normalize(el("globalSearch").value);
      const tb = el("tbodySearch");

      if(!q){
        tb.innerHTML = `<tr><td colspan="8" class="muted">Ukucaj tim gore (npr. Dadeks) da vidi≈° sve utakmice tog tima.</td></tr>`;
        return;
      }

      let list = [...activeList()].filter(m=>{
        const a = normalize(m.domacin);
        const b = normalize(m.gost);
        const t = normalize(m.teren);
        const f = normalize(m.faza);
        const g = normalize(m.grupa);
        const n = normalize(m.napomena);
        return a.includes(q) || b.includes(q) || t.includes(q) || f.includes(q) || g.includes(q) || n.includes(q);
      });

      list.sort((a,b)=> {
        const ta = a.vreme ? new Date(a.vreme).getTime() : 0;
        const tb2 = b.vreme ? new Date(b.vreme).getTime() : 0;
        return ta - tb2;
      });

      if(!list.length){
        tb.innerHTML = `<tr><td colspan="8" class="muted">Nema utakmica za ‚Äú${el("globalSearch").value}‚Äù u godi≈°tu ${activeGodiste}.</td></tr>`;
        return;
      }

      tb.innerHTML = list.map(r=>`
        <tr>
          <td><b>${r.godiste ?? ""}</b></td>
          <td>${fmtTime(r.vreme)}</td>
          <td>${r.teren ?? "‚Äî"}</td>
          <td>${r.faza ?? ""}</td>
          <td>${r.grupa ?? ""}</td>
          <td><b>${r.domacin ?? ""}</b> <span class="muted">vs</span> <b>${r.gost ?? ""}</b></td>
          <td class="score">${(r.gol_domacin ?? 0)} : ${(r.gol_gost ?? 0)}</td>
          <td>${tagStatus(r.status)}</td>
        </tr>
      `).join("");
    }

    function renderAll(){
      renderLockInfo();
      renderLive();
      renderRaspored();
      renderGrupe();
      renderElim();
    }

    // ===== Tabs =====
    function showTab(name){
      ["live","raspored","grupe","elim"].forEach(t=>{
        el("tab-"+t).style.display = (t===name) ? "block" : "none";
      });
      document.querySelectorAll(".tab").forEach(b=>{
        b.classList.toggle("active", b.getAttribute("data-tab")===name);
      });
      setQS(name);
    }

    document.querySelectorAll(".tab").forEach(b=>{
      b.addEventListener("click", ()=> showTab(b.getAttribute("data-tab")));
    });

    // ===== Listeners =====
    ["fGrupa","fFaza","fStatus","fSearch"].forEach(id=>{
      el(id).addEventListener("input", renderLive);
      el(id).addEventListener("change", renderLive);
    });
    ["rTeren","rDan","rFaza"].forEach(id=>{
      el(id).addEventListener("change", renderRaspored);
    });
    ["gGrupa"].forEach(id=>{
      el(id).addEventListener("change", renderGrupe);
    });

    el("btnRefresh").addEventListener("click", load);

    el("globalSearch").addEventListener("input", renderGlobalSearch);
    el("btnClearSearch").addEventListener("click", ()=>{
      el("globalSearch").value = "";
      renderGlobalSearch();
    });

    // ===== Load =====
    async function load(){
      setConn("loading");
      const { data, error } = await sb
        .from("matches")
        .select("*")
        .order("vreme", { ascending:true })
        .order("created_at", { ascending:true });

      if(error){
        setConn("bad");
        el("tbodyLive").innerHTML = `<tr><td colspan="8" style="color:#ff4d6d;font-weight:800">Gre≈°ka SELECT: ${error.message}</td></tr>`;
        return;
      }

      setConn("ok");
      ALL = data || [];
      el("lastUpdate").textContent = "A≈æurirano: " + new Date().toLocaleString("sr-ME");

      applyQS();
      buildGenBar();
      fillSelectsFromActive();
      renderAll();
      renderGlobalSearch();
    }

    // ===== Realtime (debounce) =====
    let rtTimer = null;
    function scheduleReload(){
      clearTimeout(rtTimer);
      rtTimer = setTimeout(()=>load(), 300);
    }

    sb.channel("matches-realtime-site")
      .on("postgres_changes", { event:"*", schema:"public", table:"matches" }, scheduleReload)
      .subscribe();

    load();

    // PWA
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
      });
    }
  </script>
</body>
</html>
