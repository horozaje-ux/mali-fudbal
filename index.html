<!doctype html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mali fudbal ‚Äì Live</title>
  <meta name="theme-color" content="#0b1020" />
  <style>
    :root{
      --bg:#070a14; --card:rgba(255,255,255,.06); --card2:rgba(255,255,255,.10);
      --text:#e9eefc; --muted:rgba(233,238,252,.70); --line:rgba(255,255,255,.10);
      --ok:#27e38a; --warn:#ffcc66; --bad:#ff4d6d; --glow: 0 10px 30px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 450px at 15% 15%, rgba(70,120,255,.28), transparent 60%),
        radial-gradient(800px 400px at 85% 10%, rgba(255,90,180,.22), transparent 55%),
        radial-gradient(900px 500px at 50% 90%, rgba(40,255,160,.12), transparent 55%),
        linear-gradient(180deg, #050817, #070a14 55%, #050714);
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0 14px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg, rgba(70,120,255,.9), rgba(255,90,180,.85));box-shadow:var(--glow);display:grid;place-items:center;font-weight:900}
    .brand h1{margin:0;font-size:18px;line-height:1.1}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    a.btn, button.btn{
      appearance:none;border:1px solid var(--line);background:var(--card);color:var(--text);text-decoration:none;
      padding:10px 12px;border-radius:14px;display:inline-flex;align-items:center;gap:8px;cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,.25);transition:.15s transform,.15s background,.15s border;font-size:13px
    }
    a.btn:hover, button.btn:hover{transform:translateY(-1px);background:var(--card2);border-color:rgba(255,255,255,.18)}
    .btn.primary{background:linear-gradient(135deg, rgba(70,120,255,.75), rgba(255,90,180,.55));border-color:rgba(255,255,255,.15)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn);box-shadow:0 0 0 4px rgba(255,204,102,.15)}
    .dot.ok{background:var(--ok);box-shadow:0 0 0 4px rgba(39,227,138,.14)}
    .dot.bad{background:var(--bad);box-shadow:0 0 0 4px rgba(255,77,109,.14)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--glow)}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px}
    .tab{padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.05);cursor:pointer;font-size:13px}
    .tab.active{background:linear-gradient(135deg, rgba(70,120,255,.55), rgba(255,90,180,.35));border-color:rgba(255,255,255,.16)}
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    select,input{
      width:100%; padding:11px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(0,0,0,.18_tf);color:var(--text);outline:none
    }
    .filters>*{flex:1 1 160px}
    .small{font-size:12px;color:var(--muted)}
    .sectionTitle{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:10px 2px 10px}
    .tableWrap{overflow:auto;border-radius:16px;border:1px solid rgba(255,255,255,.10)}
    table{width:100%;border-collapse:collapse;min-width:780px}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:13px}
    th{color:rgba(233,238,252,.75);font-weight:700}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);font-size:12px;white-space:nowrap}
    .tag.live{border-color:rgba(255,204,102,.35);background:rgba(255,204,102,.12)}
    .tag.done{border-color:rgba(39,227,138,.35);background:rgba(39,227,138,.12)}
    .tag.wait{border-color:rgba(233,238,252,.20);background:rgba(233,238,252,.07)}
    .score{font-weight:900}
    .muted{color:var(--muted)}
    .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.twoCol{grid-template-columns:1fr}}
    .bracket{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:900px){.bracket{grid-template-columns:1fr}}
    .matchCard{padding:12px;border-radius:16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10)}
    .matchRow{display:flex;justify-content:space-between;gap:10px;margin:6px 0}
    .footer{margin:18px 0 6px;text-align:center;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">MF</div>
        <div>
          <h1>Mali fudbal ‚Äì Turnir</h1>
          <div class="sub">Grupe ‚Ä¢ Raspored ‚Ä¢ Eliminacije ‚Ä¢ Live</div>
        </div>
      </div>

      <div class="btns">
        <span class="pill"><span class="dot" id="connDot"></span><span id="connText">Spajam se‚Ä¶</span></span>
        <a class="btn primary" href="./admin.html">‚öôÔ∏è Admin</a>
        <button class="btn" id="btnRefresh">üîÑ Osvje≈æi</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="live">üî• Live</button>
      <button class="tab" data-tab="raspored">üóìÔ∏è Raspored</button>
      <button class="tab" data-tab="grupe">üìä Grupe</button>
      <button class="tab" data-tab="elim">üèÜ Eliminacije</button>
    </div>

    <!-- LIVE -->
    <div id="tab-live" class="card">
      <div class="sectionTitle">
        <b>Live / Sve utakmice</b>
        <span class="small" id="lastUpdate">‚Äî</span>
      </div>

      <div class="filters">
        <select id="fGodiste"><option value="">Sva godi≈°ta</option></select>
        <select id="fGrupa"><option value="">Sve grupe</option></select>
        <select id="fFaza">
          <option value="">Sve faze</option>
          <option value="grupa">grupa</option>
          <option value="cetvrtfinale">ƒçetvrtfinale</option>
          <option value="polufinale">polufinale</option>
          <option value="finale">finale</option>
        </select>
        <select id="fStatus">
          <option value="">Svi statusi</option>
          <option value="ceka">ƒçeka</option>
          <option value="uzivo">u≈æivo</option>
          <option value="gotovo">gotovo</option>
        </select>
        <input id="fSearch" placeholder="Pretraga (Dadeks, Buduƒánost‚Ä¶)" />
      </div>

      <div class="tableWrap" style="margin-top:12px">
        <table>
          <thead>
            <tr>
              <th>Vrijeme</th><th>Teren</th><th>Godi≈°te</th><th>Grupa</th><th>Faza</th><th>Meƒç</th><th>Rezultat</th><th>Status</th>
            </tr>
          </thead>
          <tbody id="tbodyLive"><tr><td colspan="8" class="muted">Uƒçitavam‚Ä¶</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- RASPORED -->
    <div id="tab-raspored" class="card" style="display:none;margin-top:14px">
      <div class="sectionTitle">
        <b>Raspored (teren + vrijeme)</b>
        <span class="small">sortirano po vremenu</span>
      </div>

      <div class="filters">
        <select id="rTeren"><option value="">Svi tereni</option></select>
        <select id="rDan"><option value="">Svi dani</option></select>
        <select id="rGodiste"><option value="">Sva godi≈°ta</option></select>
        <select id="rFaza"><option value="">Sve faze</option></select>
      </div>

      <div class="tableWrap" style="margin-top:12px">
        <table>
          <thead>
            <tr>
              <th>Vrijeme</th><th>Teren</th><th>Faza</th><th>Godi≈°te</th><th>Grupa</th><th>Meƒç</th><th>Status</th>
            </tr>
          </thead>
          <tbody id="tbodyRaspored"><tr><td colspan="7" class="muted">Uƒçitavam‚Ä¶</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- GRUPE -->
    <div id="tab-grupe" class="card" style="display:none;margin-top:14px">
      <div class="sectionTitle">
        <b>Tabele grupa</b>
        <span class="small">raƒçuna se iz utakmica faze ‚Äúgrupa‚Äù</span>
      </div>

      <div class="filters">
        <select id="gGodiste"><option value="">Sva godi≈°ta</option></select>
        <select id="gGrupa"><option value="">Sve grupe</option></select>
      </div>

      <div id="groupsWrap" style="margin-top:12px" class="twoCol"></div>
    </div>

    <!-- ELIMINACIJE -->
    <div id="tab-elim" class="card" style="display:none;margin-top:14px">
      <div class="sectionTitle">
        <b>Eliminacije</b>
        <span class="small">¬º ‚Ä¢ ¬Ω ‚Ä¢ finale</span>
      </div>

      <div class="filters">
        <select id="eGodiste"><option value="">Sva godi≈°ta</option></select>
      </div>

      <div class="bracket" style="margin-top:12px">
        <div class="card" style="padding:12px">
          <b>ƒåetvrtfinale</b>
          <div id="qfWrap" style="display:grid;gap:10px;margin-top:10px"></div>
        </div>
        <div class="card" style="padding:12px">
          <b>Polufinale</b>
          <div id="sfWrap" style="display:grid;gap:10px;margin-top:10px"></div>
        </div>
        <div class="card" style="padding:12px">
          <b>Finale</b>
          <div id="fWrap" style="display:grid;gap:10px;margin-top:10px"></div>
        </div>
      </div>
    </div>

    <div class="footer">¬© Mali fudbal ‚Ä¢ Live sistem</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ‚úÖ TVOJ SUPABASE (PUBLISHABLE / ANON KEY) ‚Äî ovo ide u browser
    const SUPABASE_URL = "https://ayakstyzqrsjvrbfwgfs.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_DZJST_2cQWJU89oXbyMipg_0O-dmc-l";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const el = (id)=>document.getElementById(id);

    let ALL = [];

    function setConn(state){
      const dot = el("connDot");
      const text = el("connText");
      if(state==="ok"){ dot.className="dot ok"; text.textContent="Online"; }
      else if(state==="bad"){ dot.className="dot bad"; text.textContent="Gre≈°ka"; }
      else { dot.className="dot"; text.textContent="Spajam se‚Ä¶"; }
    }
    function tagStatus(s){
      if(s==="uzivo") return `<span class="tag live">üü° u≈æivo</span>`;
      if(s==="gotovo") return `<span class="tag done">üü¢ gotovo</span>`;
      return `<span class="tag wait">‚ö™ ƒçeka</span>`;
    }
    function fmtTime(v){
      if(!v) return "‚Äî";
      try{
        const d = new Date(v);
        if(isNaN(d)) return String(v);
        return d.toLocaleString();
      }catch(e){ return String(v); }
    }
    function dayKey(v){
      if(!v) return "";
      const d = new Date(v);
      if(isNaN(d)) return "";
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    // ---------- LOAD ----------
    async function load(){
      setConn("loading");

      const { data, error } = await sb
        .from("matches")
        .select("*")
        .order("vreme", { ascending:true })
        .order("created_at", { ascending:true });

      if(error){
        setConn("bad");
        el("tbodyLive").innerHTML = `<tr><td colspan="8" style="color:#ff4d6d;font-weight:800">Gre≈°ka SELECT: ${error.message}</td></tr>`;
        el("tbodyRaspored").innerHTML = `<tr><td colspan="7" class="muted">‚Äî</td></tr>`;
        return;
      }

      setConn("ok");
      ALL = data || [];
      el("lastUpdate").textContent = "A≈æurirano: " + new Date().toLocaleString();

      fillAllSelects();
      renderLive();
      renderRaspored();
      renderGrupe();
      renderElim();
    }

    // ---------- SELECT POPULATE ----------
    function uniq(arr){ return Array.from(new Set(arr.filter(Boolean))); }

    function setOptions(selectId, values, firstLabel){
      const sel = el(selectId);
      sel.innerHTML = `<option value="">${firstLabel}</option>` + values.map(v=>`<option value="${v}">${v}</option>`).join("");
    }

    function fillAllSelects(){
      const godista = uniq(ALL.map(x=>x.godiste)).sort();
      const grupe = uniq(ALL.map(x=>x.grupa)).sort();
      const tereni = uniq(ALL.map(x=>x.teren)).sort();
      const dani = uniq(ALL.map(x=>dayKey(x.vreme))).sort();
      const faze = uniq(ALL.map(x=>x.faza)).sort();

      setOptions("fGodiste", godista, "Sva godi≈°ta");
      setOptions("fGrupa", grupe, "Sve grupe");

      setOptions("rGodiste", godista, "Sva godi≈°ta");
      setOptions("rTeren", tereni, "Svi tereni");
      setOptions("rDan", dani, "Svi dani");
      setOptions("rFaza", faze, "Sve faze");

      setOptions("gGodiste", godista, "Sva godi≈°ta");
      setOptions("gGrupa", grupe, "Sve grupe");

      setOptions("eGodiste", godista, "Sva godi≈°ta");
    }

    // ---------- LIVE ----------
    function renderLive(){
      const god = el("fGodiste").value.trim();
      const grp = el("fGrupa").value.trim();
      const faza = el("fFaza").value.trim();
      const st = el("fStatus").value.trim();
      const q = el("fSearch").value.trim().toLowerCase();

      let list = [...ALL];
      if(god) list = list.filter(x=>String(x.godiste||"")===god);
      if(grp) list = list.filter(x=>String(x.grupa||"")===grp);
      if(faza) list = list.filter(x=>(x.faza||"")===faza);
      if(st) list = list.filter(x=>(x.status||"")===st);
      if(q){
        list = list.filter(x =>
          (x.domacin||"").toLowerCase().includes(q) ||
          (x.gost||"").toLowerCase().includes(q) ||
          (x.faza||"").toLowerCase().includes(q) ||
          (x.grupa||"").toLowerCase().includes(q) ||
          (x.teren||"").toLowerCase().includes(q)
        );
      }

      const tb = el("tbodyLive");
      if(!list.length){
        tb.innerHTML = `<tr><td colspan="8" class="muted">Nema utakmica za filter.</td></tr>`;
        return;
      }

      tb.innerHTML = list.map(r=>`
        <tr>
          <td>${fmtTime(r.vreme)}</td>
          <td>${r.teren ?? "‚Äî"}</td>
          <td>${r.godiste ?? ""}</td>
          <td>${r.grupa ?? ""}</td>
          <td>${r.faza ?? ""}</td>
          <td><b>${r.domacin ?? ""}</b> <span class="muted">vs</span> <b>${r.gost ?? ""}</b></td>
          <td class="score">${(r.gol_domacin ?? 0)} : ${(r.gol_gost ?? 0)}</td>
          <td>${tagStatus(r.status)}</td>
        </tr>
      `).join("");
    }

    // ---------- RASPORED ----------
    function renderRaspored(){
      const teren = el("rTeren").value.trim();
      const dan = el("rDan").value.trim();
      const god = el("rGodiste").value.trim();
      const faza = el("rFaza").value.trim();

      let list = [...ALL].sort((a,b)=> new Date(a.vreme||0)-new Date(b.vreme||0));

      if(teren) list = list.filter(x=>(x.teren||"")===teren);
      if(dan) list = list.filter(x=>dayKey(x.vreme)===dan);
      if(god) list = list.filter(x=>String(x.godiste||"")===god);
      if(faza) list = list.filter(x=>(x.faza||"")===faza);

      const tb = el("tbodyRaspored");
      if(!list.length){
        tb.innerHTML = `<tr><td colspan="7" class="muted">Nema utakmica u rasporedu za filter.</td></tr>`;
        return;
      }

      tb.innerHTML = list.map(r=>`
        <tr>
          <td>${fmtTime(r.vreme)}</td>
          <td>${r.teren ?? "‚Äî"}</td>
          <td>${r.faza ?? ""}</td>
          <td>${r.godiste ?? ""}</td>
          <td>${r.grupa ?? ""}</td>
          <td><b>${r.domacin ?? ""}</b> <span class="muted">vs</span> <b>${r.gost ?? ""}</b></td>
          <td>${tagStatus(r.status)}</td>
        </tr>
      `).join("");
    }

    // ---------- GRUPE (tabele) ----------
    function computeStandings(matches){
      const teams = {};
      function ensure(name){
        if(!teams[name]){
          teams[name] = { team:name, P:0,W:0,D:0,L:0,GF:0,GA:0,GD:0,PTS:0 };
        }
        return teams[name];
      }

      for(const m of matches){
        const a = (m.domacin||"").trim();
        const b = (m.gost||"").trim();
        if(!a || !b) continue;

        const ga = Number(m.gol_domacin ?? 0);
        const gb = Number(m.gol_gost ?? 0);

        if((m.status||"") !== "gotovo" && (m.gol_domacin==null || m.gol_gost==null)) continue;

        const A = ensure(a);
        const B = ensure(b);

        A.P++; B.P++;
        A.GF += ga; A.GA += gb;
        B.GF += gb; B.GA += ga;

        if(ga > gb){ A.W++; A.PTS+=3; B.L++; }
        else if(ga < gb){ B.W++; B.PTS+=3; A.L++; }
        else { A.D++; B.D++; A.PTS+=1; B.PTS+=1; }
      }

      const list = Object.values(teams).map(t=> ({...t, GD: (t.GF - t.GA)}));
      list.sort((x,y)=>
        (y.PTS-x.PTS) ||
        (y.GD-x.GD) ||
        (y.GF-x.GF) ||
        x.team.localeCompare(y.team)
      );
      return list;
    }

    function renderGrupe(){
      const godFilter = el("gGodiste").value.trim();
      const grpFilter = el("gGrupa").value.trim();

      let base = ALL.filter(x => (x.faza||"") === "grupa");

      if(godFilter) base = base.filter(x => String(x.godiste||"") === godFilter);
      if(grpFilter) base = base.filter(x => String(x.grupa||"") === grpFilter);

      const map = new Map();
      for(const m of base){
        const key = `${m.godiste||""}__${m.grupa||""}`;
        if(!map.has(key)) map.set(key, []);
        map.get(key).push(m);
      }

      const wrap = el("groupsWrap");
      const keys = Array.from(map.keys()).sort();
      if(!keys.length){
        wrap.innerHTML = `<div class="muted">Nema grupnih utakmica (faza = grupa).</div>`;
        return;
      }

      wrap.innerHTML = keys.map(k=>{
        const [god,grp] = k.split("__");
        const standings = computeStandings(map.get(k));

        return `
          <div class="card" style="padding:12px">
            <div class="sectionTitle" style="margin:0 0 8px">
              <b>Godi≈°te ${god} ‚Ä¢ Grupa ${grp}</b>
              <span class="small">PTS / GD / GF</span>
            </div>
            <div class="tableWrap">
              <table style="min-width:520px">
                <thead>
                  <tr>
                    <th>#</th><th>Tim</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>PTS</th>
                  </tr>
                </thead>
                <tbody>
                  ${standings.map((t,i)=>`
                    <tr>
                      <td>${i+1}</td>
                      <td><b>${t.team}</b></td>
                      <td>${t.P}</td><td>${t.W}</td><td>${t.D}</td><td>${t.L}</td>
                      <td>${t.GF}</td><td>${t.GA}</td><td>${t.GD}</td><td class="score">${t.PTS}</td>
                    </tr>
                  `).join("") || `<tr><td colspan="10" class="muted">Nema odigranih meƒçeva.</td></tr>`}
                </tbody>
              </table>
            </div>
            <div class="small" style="margin-top:8px">Sort: bodovi, gol-razlika, dati golovi.</div>
          </div>
        `;
      }).join("");
    }

    // ---------- ELIMINACIJE ----------
    function matchMini(r){
      return `
        <div class="matchCard">
          <div class="small muted">${fmtTime(r.vreme)} ‚Ä¢ ${r.teren ?? "‚Äî"}</div>
          <div class="matchRow"><b>${r.domacin ?? ""}</b><span class="score">${(r.gol_domacin ?? 0)}</span></div>
          <div class="matchRow"><b>${r.gost ?? ""}</b><span class="score">${(r.gol_gost ?? 0)}</span></div>
          <div style="margin-top:6px">${tagStatus(r.status)}</div>
        </div>
      `;
    }

    function renderElim(){
      const god = el("eGodiste").value.trim();
      let list = [...ALL].filter(x => ["cetvrtfinale","polufinale","finale"].includes(x.faza||""));
      if(god) list = list.filter(x=>String(x.godiste||"")===god);

      const qf = list.filter(x=>(x.faza||"")==="cetvrtfinale");
      const sf = list.filter(x=>(x.faza||"")==="polufinale");
      const fin = list.filter(x=>(x.faza||"")==="finale");

      el("qfWrap").innerHTML = qf.length ? qf.map(matchMini).join("") : `<div class="muted">Nema ƒçetvrtfinala.</div>`;
      el("sfWrap").innerHTML = sf.length ? sf.map(matchMini).join("") : `<div class="muted">Nema polufinala.</div>`;
      el("fWrap").innerHTML = fin.length ? fin.map(matchMini).join("") : `<div class="muted">Nema finala.</div>`;
    }

    // ---------- TABS ----------
    function showTab(name){
      ["live","raspored","grupe","elim"].forEach(t=>{
        el("tab-"+t).style.display = (t===name) ? "block" : "none";
      });
      document.querySelectorAll(".tab").forEach(b=>{
        b.classList.toggle("active", b.getAttribute("data-tab")===name);
      });
    }
    document.querySelectorAll(".tab").forEach(b=>{
      b.addEventListener("click", ()=> showTab(b.getAttribute("data-tab")));
    });

    // ---------- LISTENERS ----------
    ["fGodiste","fGrupa","fFaza","fStatus","fSearch"].forEach(id=>{
      el(id).addEventListener("input", renderLive);
      el(id).addEventListener("change", renderLive);
    });
    ["rTeren","rDan","rGodiste","rFaza"].forEach(id=>{
      el(id).addEventListener("change", renderRaspored);
    });
    ["gGodiste","gGrupa"].forEach(id=>{
      el(id).addEventListener("change", renderGrupe);
    });
    ["eGodiste"].forEach(id=>{
      el(id).addEventListener("change", renderElim);
    });

    el("btnRefresh").addEventListener("click", load);

    // realtime
    sb.channel("matches-realtime-site")
      .on("postgres_changes", { event:"*", schema:"public", table:"matches" }, () => load())
      .subscribe();

    // init
    load();
  </script>
</body>
</html>
